<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Golf Tracker | Lazy B Studios</title>
  
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Golf Tracker">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#2e7d32">

  <link rel="manifest" href="manifest.json">

  <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MTIiIGhlaWdodD0iNTEyIiB2aWV3Qm94PSIwIDAgNTEyIDUxMiI+PHJlY3Qgd2lkdGg9IjUxMiIgaGVpZ2h0PSI1MTIiIGZpbGw9IiMyZTdkMzIiLz48Y2lyY2xlIGN4PSIyNTYiIGN5PSIyMTAiIHI9Ijk1IiBmaWxsPSIjZmZmZmZmIi8+PHBhdGggZD0iTTIzNiAyOTUgSDI3NiBMMjY2IDQzMCBIMjQ2IFoiIGZpbGw9IiNmZmZmZmYiLz48L3N2Zz4=">
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MTIiIGhlaWdodD0iNTEyIiB2aWV3Qm94PSIwIDAgNTEyIDUxMiI+PHJlY3Qgd2lkdGg9IjUxMiIgaGVpZ2h0PSI1MTIiIGZpbGw9IiMyZTdkMzIiLz48Y2lyY2xlIGN4PSIyNTYiIGN5PSIyMTAiIHI9Ijk1IiBmaWxsPSIjZmZmZmZmIi8+PHBhdGggZD0iTTIzNiAyOTUgSDI3NiBMMjY2IDQzMCBIMjQ2IFoiIGZpbGw9IiNmZmZmZmYiLz48L3N2Zz4=">

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root { --primary: #2e7d32; --dark: #1b5e20; --accent: #ffa000; --bg: #f4f6f8; --card-bg: #ffffff; --text: #333333; --danger: #d32f2f; --border: #dddddd; }
    body.dark-mode { --bg: #121212; --card-bg: #1e1e1e; --text: #e0e0e0; --border: #333333; }

    body { font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 20px; transition: background 0.3s, color 0.3s; -webkit-tap-highlight-color: transparent; }
    .header { background: linear-gradient(135deg, var(--primary), var(--dark)); color: white; padding: 25px 20px; text-align: center; border-bottom: 5px solid var(--accent); }
    .hcp-display { font-size: 3.5rem; font-weight: 900; margin: 5px 0; display: flex; align-items: center; justify-content: center; gap: 10px; }
    .trend-arrow { font-size: 1.5rem; padding: 5px 10px; border-radius: 50%; background: rgba(255,255,255,0.2); }
    
    .nav-tabs { display: flex; background: var(--card-bg); position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.1); overflow-x: auto; border-bottom: 1px solid var(--border); }
    .tab-link { flex: 1; padding: 15px; text-align: center; font-size: 0.7rem; font-weight: bold; cursor: pointer; color: #888; border-bottom: 3px solid transparent; white-space: nowrap; }
    .tab-link.active { color: var(--primary); border-bottom: 3px solid var(--primary); }
    
    .container { max-width: 600px; margin: 0 auto; padding: 15px; }
    .card { background: var(--card-bg); border-radius: 12px; padding: 1.2rem; margin-bottom: 1rem; border: 1px solid var(--border); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    
    .btn { width: 100%; padding: 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; font-size: 1rem; margin-top: 10px; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-outline { background: none; border: 1px solid var(--primary); color: var(--primary); }
    .btn-danger-outline { background: none; border: 1px solid var(--danger); color: var(--danger); }
    .btn-sm { padding: 5px 10px; font-size: 0.7rem; width: auto; margin: 0; cursor: pointer; border-radius: 4px; font-weight: bold; border: 1px solid var(--border); background: var(--card-bg); color: var(--text); }
    .btn-xs { padding: 4px 8px; font-size: 0.7rem; margin-left: 6px; border-radius: 4px; border: 1px solid var(--border); background: var(--card-bg); color: var(--text); cursor: pointer; }
    
    .form-control { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid var(--border); border-radius: 8px; box-sizing: border-box; font-size: 16px; background: var(--card-bg); color: var(--text); }
    .hidden { display: none !important; }
    .lb-row { display: grid; grid-template-columns: 30px 1fr 60px 50px; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border); cursor: pointer; }
    .legal-text { font-size: 0.85rem; color: var(--text); background: var(--bg); padding: 15px; border: 1px solid var(--border); max-height: 400px; overflow-y: auto; margin: 10px 0; border-radius: 8px; line-height: 1.6; }
    .legal-text h4 { color: var(--primary); margin-top: 15px; border-bottom: 1px solid var(--border); padding-bottom: 5px; }
    .group-card { background: #f0f7f0; color: #333; border-left: 4px solid var(--primary); padding: 15px; margin-bottom: 15px; border-radius: 8px; }
    body.dark-mode .group-card { background: #1a2e1a; color: #e0e0e0; }
  </style>
</head>
<body>

<div id="view-auth" class="container" style="margin-top: 5vh;">
  <div class="card" style="text-align: center;">
    <h2 style="color: var(--primary);">â›³ Golf Tracker</h2>
    <div style="margin-bottom:10px;">
      <button class="btn-sm" onclick="window.setAuthMode('signin')">Sign In</button>
      <button class="btn-sm" onclick="window.setAuthMode('signup')">Create Account</button>
    </div>
    <input type="email" id="email" class="form-control" placeholder="Email">
    <div id="display-name-wrapper" class="hidden"><input type="text" id="display-name" class="form-control" placeholder="Display Name"></div>
    <input type="password" id="password" class="form-control" placeholder="Password">
    <div id="password-confirm-wrapper" class="hidden"><input type="password" id="password-confirm" class="form-control" placeholder="Confirm Password"></div>
    <button class="btn btn-primary" onclick="window.handleAuth()" id="auth-btn-label">Sign In</button>
  </div>
</div>

<div id="view-app" class="hidden">
  <div class="header">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <span id="user-display-name" style="font-weight: bold; font-size: 0.9rem;">Connecting...</span>
      <button onclick="window.handleLogout()" class="btn-sm">Logout</button>
    </div>
    <div class="hcp-display">
      <span id="dash-hcp">--</span>
      <span id="trend-arrow" class="trend-arrow hidden">â†”</span>
    </div>
    <div style="font-size: 0.7rem; font-weight: bold;">WHS HANDICAP INDEX</div>
  </div>

  <div class="nav-tabs">
    <div class="tab-link active" onclick="window.showTab('history', this)">HISTORY</div>
    <div class="tab-link" onclick="window.showTab('add', this)">ADD SCORES</div>
    <div class="tab-link" onclick="window.showTab('leader', this)">RANKINGS</div>
    <div class="tab-link" onclick="window.showTab('groups', this)">GROUPS</div>
    <div class="tab-link" onclick="window.showTab('settings', this)">SETTINGS</div>
    <div class="tab-link" onclick="window.showTab('help-main', this)">HELP</div>
  </div>

  <div class="container">
    <div id="tab-history"><div id="recent-list">Loading scores...</div></div>

    <div id="tab-add" class="hidden">
      <div class="card">
        <h3 id="add-title">Add Score</h3>
        <select id="r-course-select" class="form-control" onchange="window.autoFillCourse()"><option value="">-- Select Course --</option></select>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
          <input type="number" step="0.1" id="r-rating" class="form-control" placeholder="Rating">
          <input type="number" id="r-slope" class="form-control" placeholder="Slope">
        </div>
        <input type="number" id="r-score" class="form-control" placeholder="Gross Score">
        <input type="date" id="r-date" class="form-control">
        <button id="btn-save-round" class="btn btn-primary" onclick="window.saveRound()">Save Round</button>
      </div>
    </div>

    <div id="tab-leader" class="hidden">
      <div class="card">
        <h3>Leaderboard</h3>
        <div style="display: grid; grid-template-columns: 30px 1fr 60px 50px; font-size: 0.65rem; font-weight: bold; color: #999; margin-bottom: 5px;">
          <span>#</span><span>NAME</span><span>INDEX</span><span>ROUNDS</span>
        </div>
        <div id="lb-list"></div>
      </div>
      <div id="lb-history-card" class="card hidden"><h3 id="lb-history-title">Player History</h3><div id="lb-history-list"></div></div>
    </div>

    <div id="tab-groups" class="hidden">
      <div id="group-status" class="card"></div>
      <div class="card">
        <h3>Create Group</h3>
        <input type="text" id="new-group-name" class="form-control" placeholder="Group Name">
        <div style="display:flex; gap:8px; align-items:center; margin-bottom:10px;">
          <input type="text" id="new-group-code" class="form-control" placeholder="Code" readonly style="margin:0;">
          <button class="btn-sm" onclick="window.handleGenerateCode()">Generate</button>
        </div>
        <button class="btn btn-primary" onclick="window.createGroup()">Create & Join</button>
      </div>
      <div class="card">
        <h3>Join Group</h3>
        <input type="text" id="join-code" class="form-control" placeholder="Enter Join Code" style="text-transform: uppercase;">
        <button class="btn btn-outline" onclick="window.joinGroup()">Join</button>
      </div>
    </div>

    <div id="tab-settings" class="hidden">
      <div class="card">
        <h3>Preferences</h3>
        <button class="btn btn-outline" id="dark-mode-toggle" onclick="window.toggleDarkMode()">ðŸŒ™ Switch to Dark Mode</button>
        <button class="btn btn-outline" style="margin-top:10px;" onclick="window.exportDataCSV()">ðŸ“Š Export Scores (CSV)</button>
      </div>
      <div class="card">
        <h3>Course Manager</h3>
        <select id="m-course-select" class="form-control" onchange="window.prepCourseEdit()"><option value="new">-- Add New Course --</option></select>
        <hr>
        <div id="course-form">
          <input type="hidden" id="edit-c-id"><input type="text" id="edit-c-name" class="form-control" placeholder="Course Name"><input type="text" id="edit-c-tee" class="form-control" placeholder="Tee Box">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <input type="number" step="0.1" id="edit-c-rating" class="form-control" placeholder="Rating"><input type="number" id="edit-c-slope" class="form-control" placeholder="Slope">
          </div>
          <button class="btn btn-primary" onclick="window.saveCourse()">Save Course</button>
          <button id="btn-c-del" class="btn btn-danger-outline hidden" onclick="window.deleteCourse()">Delete Course</button>
        </div>
      </div>
    </div>

    <div id="tab-help-main" class="hidden">
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
        <button class="btn btn-outline" onclick="window.toggleHelpSub('set-help')">FAQ</button>
        <button class="btn btn-outline" onclick="window.toggleHelpSub('set-contact')">Contact Us</button>
        <button class="btn btn-outline" onclick="window.toggleHelpSub('set-privacy')">Privacy</button>
        <button class="btn btn-outline" onclick="window.toggleHelpSub('set-terms')">Terms</button>
      </div>

      <div id="set-help" class="card hidden">
        <h3>Frequently Asked Questions</h3>
        <div class="legal-text">
          <h4>How is my handicap calculated?</h4>
          
          <p>Every time you post a score, we calculate a "Score Differential" using the Course Rating and Slope. When you have 20 rounds, the app averages your <strong>best 8</strong> differentials and multiplies the result by <strong>0.96</strong>.</p>
          <h4>What are Rating and Slope?</h4>
          <p><strong>Course Rating:</strong> Strokes a scratch golfer should take.</p>
          <p><strong>Slope Rating:</strong> Relative difficulty for a non-scratch player compared to scratch (Standard is 113).</p>
          <h4>What does the Trend Arrow mean?</h4>
          <ul>
            <li><strong style="color:#2e7d32">â†“ Green:</strong> Handicap improved (down).</li>
            <li><strong style="color:#d32f2f">â†‘ Red:</strong> Handicap rose.</li>
            <li><strong style="color:#ffa000">â†” Orange:</strong> No change.</li>
          </ul>
        </div>
      </div>

      <div id="set-contact" class="card hidden" style="text-align: center;">
        <h3>Contact Us</h3>
        <p>Found a bug or have a suggestion? We'd love to hear from you.</p>
        <button class="btn btn-primary" onclick="window.location.href='mailto:support@lazybstudios.com?subject=Golf%20Tracker%20Support'">
          ðŸ“§ Email support@lazybstudios.com
        </button>
      </div>

      <div id="set-privacy" class="card hidden">
        <h3>Privacy Policy</h3>
        <div class="legal-text">
          <p><strong>Effective: January 19, 2026</strong></p>
          <p>We collect your email for account security and golf scores for tracking. We do not sell your data to advertisers. Your rounds are private unless you join a Group.</p>
        </div>
      </div>

      <div id="set-terms" class="card hidden">
        <h3>Terms of Service</h3>
        <div class="legal-text">
          <p>By using Golf Tracker, you agree to report scores honestly. This app is for recreational use and is not an official GHIN-certified provider. Lazy B Studios is not liable for data loss or incorrect calculations.</p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  const S_URL = 'https://vonbibroncsxrgstetow.supabase.co';
  const S_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZvbmJpYnJvbmNzeHJnc3RldG93Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1MjExMTQsImV4cCI6MjA4NDA5NzExNH0.z0x4uu-34dc2cpWK2CTZSGW9gY2a3pl-t1ANk7gyouk';
  const sb = supabase.createClient(S_URL, S_KEY);

  let user = null, profile = null, activeGroup = null, masterCourses = [], editingRoundId = null, authMode = 'signin';

  window.toggleDarkMode = () => {
    const isDark = document.body.classList.toggle('dark-mode');
    localStorage.setItem('golf-dark-mode', isDark);
    document.getElementById('dark-mode-toggle').textContent = isDark ? 'â˜€ï¸ Switch to Light Mode' : 'ðŸŒ™ Switch to Dark Mode';
    window.updateHeader(profile?.handicap_index);
  };
  if (localStorage.getItem('golf-dark-mode') === 'true') document.body.classList.add('dark-mode');

  window.exportDataCSV = async () => {
    const { data, error } = await sb.from('rounds').select('*').eq('user_id', user.id).order('date_played', {ascending: false});
    if (error || !data.length) return alert("No scores found.");
    let csv = "Date,Course,Score,Rating,Slope,Differential\n";
    data.forEach(r => { csv += `${r.date_played},"${r.course_name}",${r.score},${r.course_rating},${r.slope_rating},${r.differential}\n`; });
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.setAttribute('href', url);
    a.setAttribute('download', 'golf_scores.csv');
    a.click();
  };

  async function handleSessionChange(session) {
    user = session?.user || null;
    if (user) {
      document.getElementById('view-auth').classList.add('hidden');
      document.getElementById('view-app').classList.remove('hidden');
      document.getElementById('user-display-name').textContent = user.email.split('@')[0];
      window.refreshData(); 
    } else {
      document.getElementById('view-auth').classList.remove('hidden');
      document.getElementById('view-app').classList.add('hidden');
    }
  }

  window.refreshData = async function() {
    if (!user) return;
    try {
      const { data: p } = await sb.from('profiles').select('*').eq('id', user.id).maybeSingle();
      const prevHcp = profile?.handicap_index;
      if(p) profile = p;
      const { data: mems } = await sb.from('group_members').select('group_id').eq('user_id', user.id);
      let groups = [];
      if (mems?.length) {
        const { data: gRows } = await sb.from('groups').select('*').in('id', mems.map(m => m.group_id));
        groups = gRows || [];
      }
      activeGroup = profile?.current_group_id ? groups.find(g => g.id === profile.current_group_id) : groups[0] || null;
      window.updateHeader(prevHcp);
      window.updateGroupUI();
      window.loadHistory(); window.loadCourses(); window.loadLeaderboard();
    } catch (e) { console.error(e); }
  };

  window.updateHeader = (prevHcp) => {
    if(!user) return;
    document.getElementById('user-display-name').textContent = (profile?.display_name || user.email.split('@')[0]) + (activeGroup ? ` Â· ${activeGroup.name}` : '');
    const currentHcp = profile?.handicap_index;
    document.getElementById('dash-hcp').textContent = currentHcp?.toFixed(1) || '--';
    const arrow = document.getElementById('trend-arrow');
    if (currentHcp != null && prevHcp != null) {
      arrow.classList.remove('hidden');
      if (currentHcp < prevHcp) { arrow.textContent = 'â†“'; arrow.style.color = '#2e7d32'; }
      else if (currentHcp > prevHcp) { arrow.textContent = 'â†‘'; arrow.style.color = '#d32f2f'; }
      else { arrow.textContent = 'â†”'; arrow.style.color = '#ffa000'; }
    }
  };

  window.handleLogout = async () => { await sb.auth.signOut(); window.location.reload(); };

  window.loadCourses = async () => {
    const { data } = await sb.from('courses').select('*').order('name');
    masterCourses = data || [];
    const opts = '<option value="">-- Select --</option>' + masterCourses.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
    document.getElementById('r-course-select').innerHTML = opts;
    document.getElementById('m-course-select').innerHTML = '<option value="new">-- Add New --</option>' + opts;
  };

  window.prepCourseEdit = () => {
    const id = document.getElementById('m-course-select').value;
    const btnDel = document.getElementById('btn-c-del');
    if (id === 'new') {
      ['edit-c-id','edit-c-name','edit-c-tee','edit-c-rating','edit-c-slope'].forEach(k => document.getElementById(k).value = '');
      btnDel.classList.add('hidden');
    } else {
      const c = masterCourses.find(x => x.id == id);
      if (c) {
        document.getElementById('edit-c-id').value = c.id;
        document.getElementById('edit-c-name').value = c.name;
        document.getElementById('edit-c-tee').value = c.tee || '';
        document.getElementById('edit-c-rating').value = c.course_rating;
        document.getElementById('edit-c-slope').value = c.slope_rating;
        btnDel.classList.remove('hidden');
      }
    }
  };

  window.saveCourse = async () => {
    const id = document.getElementById('edit-c-id').value;
    const payload = { name: document.getElementById('edit-c-name').value, tee: document.getElementById('edit-c-tee').value, course_rating: parseFloat(document.getElementById('edit-c-rating').value), slope_rating: parseInt(document.getElementById('edit-c-slope').value) };
    if (id) await sb.from('courses').update(payload).eq('id', id);
    else await sb.from('courses').insert(payload);
    alert("Saved"); window.loadCourses();
  };

  window.deleteCourse = async () => {
    const id = document.getElementById('edit-c-id').value;
    if (id && confirm("Delete course?")) { await sb.from('courses').delete().eq('id', id); window.loadCourses(); window.prepCourseEdit(); }
  };

  window.loadHistory = async () => {
    const { data } = await sb.from('rounds').select('*').eq('user_id', user.id).order('date_played', {ascending:false});
    document.getElementById('recent-list').innerHTML = (data || []).map(r => `
      <div class="card" style="border-left:5px solid var(--primary); display:flex; justify-content:space-between; align-items:center;">
        <div><b>${r.score}</b> @ ${r.course_name}<br><small>${r.date_played}</small></div>
        <div><button class="btn-xs" onclick="window.editRound('${r.id}')">Edit</button><button class="btn-xs" style="color:red" onclick="window.deleteRound('${r.id}')">Del</button></div>
      </div>`).join('') || "No rounds.";
  };

  window.editRound = async (id) => {
    const { data } = await sb.from('rounds').select('*').eq('id', id).single();
    editingRoundId = id;
    document.getElementById('r-score').value = data.score;
    document.getElementById('r-rating').value = data.course_rating;
    document.getElementById('r-slope').value = data.slope_rating;
    document.getElementById('r-date').value = data.date_played;
    document.getElementById('add-title').textContent = "Edit Score";
    document.getElementById('btn-save-round').textContent = "Update Round";
    window.showTab('add', document.querySelectorAll('.tab-link')[1]);
  };

  window.deleteRound = async (id) => {
    if (confirm("Delete?")) { await sb.from('rounds').delete().eq('id', id); await window.recalcHcp(); window.refreshData(); }
  };

  window.saveRound = async () => {
    const score = parseInt(document.getElementById('r-score').value), rating = parseFloat(document.getElementById('r-rating').value), slope = parseInt(document.getElementById('r-slope').value), date = document.getElementById('r-date').value;
    const course = document.getElementById('r-course-select').selectedOptions[0]?.text || "Course";
    const diff = ((score - rating) * 113) / slope;
    if (editingRoundId) { await sb.from('rounds').update({ score, course_rating: rating, slope_rating: slope, differential: diff.toFixed(1), date_played: date, course_name: course }).eq('id', editingRoundId); editingRoundId = null; }
    else { await sb.from('rounds').insert({ user_id: user.id, score, course_rating: rating, slope_rating: slope, differential: diff.toFixed(1), date_played: date, course_name: course }); }
    await window.recalcHcp(); window.refreshData(); window.showTab('history', document.querySelector('.tab-link'));
  };

  window.recalcHcp = async () => {
    const { data: rs } = await sb.from('rounds').select('differential').eq('user_id', user.id).order('date_played', {ascending:false}).limit(20);
    if (!rs?.length) return;
    const sorted = rs.map(r => r.differential).sort((a,b) => a-b);
    const take = rs.length >= 20 ? 8 : (rs.length >= 15 ? 5 : (rs.length >= 10 ? 3 : 1));
    const avg = sorted.slice(0, take).reduce((a,b) => a+b, 0) / take;
    await sb.from('profiles').update({ handicap_index: Math.round(avg * 0.96 * 10) / 10 }).eq('id', user.id);
  };

  window.setAuthMode = (m) => {
    authMode = m;
    document.getElementById('display-name-wrapper').classList.toggle('hidden', m === 'signin');
    document.getElementById('password-confirm-wrapper').classList.toggle('hidden', m === 'signin');
    document.getElementById('auth-btn-label').textContent = m === 'signin' ? 'Sign In' : 'Create Account';
  };
  window.handleAuth = async () => {
    const email = document.getElementById('email').value, pass = document.getElementById('password').value;
    if (authMode === 'signup') {
      const { data, error } = await sb.auth.signUp({ email, password: pass });
      if (error) return alert(error.message);
      await sb.from('profiles').upsert({ id: data.user.id, display_name: document.getElementById('display-name').value || email.split('@')[0] });
      alert('Check email then sign in.');
    } else {
      const { error } = await sb.auth.signInWithPassword({ email, password: pass });
      if (error) alert(error.message);
    }
  };
  window.showTab = (n, el) => {
    document.querySelectorAll('[id^="tab-"]').forEach(t => t.classList.add('hidden'));
    document.getElementById('tab-' + n).classList.remove('hidden');
    document.querySelectorAll('.tab-link').forEach(t => t.classList.remove('active'));
    if (el) el.classList.add('active');
    if (n !== 'leader') document.getElementById('lb-history-card').classList.add('hidden');
  };
  window.toggleHelpSub = (id) => {
    ['set-help','set-contact','set-privacy','set-terms'].forEach(s => document.getElementById(s).classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
  };
  window.togglePassword = (id, btn) => { const el = document.getElementById(id); el.type = el.type === 'password' ? 'text' : 'password'; btn.textContent = el.type === 'password' ? 'Show' : 'Hide'; };
  window.handleGenerateCode = () => document.getElementById('new-group-code').value = Math.random().toString(36).substring(2, 8).toUpperCase();
  window.createGroup = async () => {
    const name = document.getElementById('new-group-name').value, code = document.getElementById('new-group-code').value;
    const { data: g } = await sb.from('groups').insert({ name, group_code: code, owner_id: user.id }).select().single();
    await sb.from('group_members').insert({ group_id: g.id, user_id: user.id });
    await sb.from('profiles').update({ current_group_id: g.id }).eq('id', user.id);
    window.refreshData();
  };
  window.joinGroup = async () => {
    const { data: g } = await sb.from('groups').select('*').eq('group_code', document.getElementById('join-code').value.toUpperCase()).single();
    if (g) { await sb.from('group_members').upsert({ group_id: g.id, user_id: user.id }); await sb.from('profiles').update({ current_group_id: g.id }).eq('id', user.id); window.refreshData(); }
  };
  window.updateGroupUI = () => { document.getElementById('group-status').innerHTML = activeGroup ? `<div class="group-card"><b>Active: ${activeGroup.name}</b><br>Code: ${activeGroup.group_code}</div>` : "No group."; };
  window.loadLeaderboard = async () => {
    const lbDiv = document.getElementById('lb-list'); if (!activeGroup) return;
    const { data: mems } = await sb.from('group_members').select('user_id').eq('group_id', activeGroup.id);
    const { data: pros } = await sb.from('profiles').select('*').in('id', (mems || []).map(m => m.user_id));
    lbDiv.innerHTML = (pros || []).sort((a,b) => (a.handicap_index ?? 99)-(b.handicap_index ?? 99)).map((p, i) => `<div class="lb-row" onclick="window.viewMemberHistory('${p.id}', '${p.display_name}')"><span>${i+1}</span><strong>${p.display_name}</strong><span>${p.handicap_index?.toFixed(1) || '--'}</span><span>View</span></div>`).join('');
  };
  window.viewMemberHistory = async (id, name) => {
    document.getElementById('lb-history-card').classList.remove('hidden');
    document.getElementById('lb-history-title').textContent = `${name}'s History`;
    const { data } = await sb.from('rounds').select('*').eq('user_id', id).order('date_played', {ascending:false});
    document.getElementById('lb-history-list').innerHTML = (data || []).map(r => `<div class="card">${r.date_played}: <b>${r.score}</b> @ ${r.course_name}</div>`).join('');
  };
  window.autoFillCourse = () => {
    const c = masterCourses.find(x => x.id == document.getElementById('r-course-select').value);
    if (c) { document.getElementById('r-rating').value = c.course_rating; document.getElementById('r-slope').value = c.slope_rating; }
  };

  sb.auth.onAuthStateChange((e, s) => handleSessionChange(s));
  (async () => { const { data: { session } } = await sb.auth.getSession(); handleSessionChange(session); })();
  document.getElementById('r-date').value = new Date().toISOString().split('T')[0];
})();
</script>
</body>
</html>

