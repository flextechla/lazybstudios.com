<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#FE2C55">
    <meta name="apple-mobile-web-app-title" content="SampleFlow">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    
    <link rel="apple-touch-icon" href="icon.svg">
    <link rel="icon" type="image/svg+xml" href="icon.svg">
    <link rel="manifest" href="manifest.json">
    
    <title>SampleFlow</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        :root { 
            --primary: #FE2C55; 
            --dark: #121212; 
            --bg: #F8F9FA; 
            --surface: #FFFFFF; 
            --green: #00C853; 
            --yellow: #FFB300; 
            --red: #FF3B30; 
            --blue: #2196F3; 
            --purple: #9C27B0; 
            --border: #E0E0E0; 
            --text-main: #121212;
            --text-secondary: #666666;
            --shadow: 0 4px 12px rgba(0,0,0,0.08); 
        }

        /* Dark Mode Variables */
        [data-theme="dark"] {
            --primary: #FF4066; 
            --dark: #FFFFFF; 
            --bg: #121212; 
            --surface: #1E1E1E; 
            --border: #333333; 
            --text-main: #FFFFFF;
            --text-secondary: #AAAAAA;
            --shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: var(--bg); 
            color: var(--text-main); 
            overflow-x: hidden;
            overscroll-behavior-y: contain;
            transition: background 0.3s, color 0.3s;
        }

        /* Compact Mode Overrides */
        body.compact-mode .sample-card { padding: 10px; margin-bottom: 12px; }
        body.compact-mode .photo-row, body.compact-mode .notes-section { display: none; }
        body.compact-mode .days-badge { margin-bottom: 5px; font-size: 0.65rem; padding: 2px 8px; }
        body.compact-mode .product-name { font-size: 1rem; margin: 2px 0 4px 0; }
        body.compact-mode .checklist-item { font-size: 0.75rem; margin-bottom: 2px; }
        body.compact-mode .row-btn { padding: 10px; font-size: 0.85rem; }
        body.compact-mode .action-container { gap: 6px; margin-top: 6px; }

        /* Collapsed Card Styles */
.sample-card.collapsed {
    margin-bottom: 8px;
    cursor: pointer;
    transition: all 0.2s;
}

.sample-card.collapsed:hover {
    box-shadow: 0 6px 16px rgba(0,0,0,0.12);
    transform: translateY(-2px);
}

.sample-summary {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
}

.summary-thumbnail {
    width: 50px;
    height: 50px;
    border-radius: 8px;
    object-fit: cover;
    flex-shrink: 0;
    background: var(--bg);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
}

.summary-info {
    flex: 1;
    min-width: 0;
}

.summary-brand {
    font-size: 0.7rem;
    color: var(--text-secondary);
    font-weight: 700;
    text-transform: uppercase;
}

.summary-product {
    font-size: 0.95rem;
    font-weight: 700;
    color: var(--text-main);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin: 2px 0;
}

.summary-meta {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.75rem;
}

.summary-badge {
    display: inline-block;
    padding: 2px 6px;
    border-radius: 8px;
    font-size: 0.7rem;
    font-weight: 800;
}

.summary-date {
    color: var(--text-secondary);
    font-weight: 600;
}

.card-expand-icon {
    font-size: 1.2rem;
    color: var(--text-secondary);
    transition: transform 0.3s;
}

.sample-card.collapsed .card-expand-icon {
    transform: rotate(0deg);
}

.sample-card:not(.collapsed) .card-expand-icon {
    transform: rotate(180deg);
}

.card-details {
    display: none;
}

.sample-card:not(.collapsed) .card-details {
    display: block;
}

.sample-card.collapsed .card-details {
    display: none;
}
        
        /* Landing Page Styles */
        #landingPage {
            min-height: 100vh;
            background: linear-gradient(135deg, #FE2C55 0%, #FF6B8A 100%);
            display: flex;
            flex-direction: column;
            padding: 20px 20px 140px 20px; 
        }
        
        #landingPage.hidden {
            display: none !important;
        }
        
        .landing-content {
            max-width: 500px;
            width: 100%;
            text-align: center;
            color: white;
            margin: auto;
        }

        /* Sticky Footer Bar */
        .landing-sticky-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--surface);
            padding: 20px;
            border-radius: 25px 25px 0 0;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.15);
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .app-icon {
            width: 120px;
            height: 120px;
            margin: 0 auto 20px;
            background: white;
            border-radius: 30px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .landing-title {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        .landing-subtitle {
            font-size: 1.1rem;
            opacity: 0.95;
            margin-bottom: 40px;
            line-height: 1.5;
        }
        
        .landing-features {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px 20px;
            margin-bottom: 30px;
            text-align: left;
        }
        
        .feature-item {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            font-size: 1rem;
        }
        
        .feature-item:last-child {
            margin-bottom: 0;
        }
        
        .feature-icon {
            font-size: 1.8rem;
            width: 50px;
            height: 50px;
            background: rgba(255,255,255,0.2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .landing-btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 15px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .landing-btn:active {
            transform: scale(0.97);
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-secondary {
            background: var(--bg);
            color: var(--text-main);
            border: 1px solid var(--border);
        }
        
        .landing-links {
            margin-top: 5px;
            display: flex;
            justify-content: center;
            gap: 20px;
            font-size: 0.85rem;
        }
        
        .landing-link {
            color: var(--text-secondary);
            text-decoration: none;
            opacity: 0.9;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }
        
        /* App Container */
        #appContainer {
            display: none;
            min-height: 100vh;
            padding-bottom: 80px;
        }
        
        #appContainer.active {
            display: block;
        }
        
        /* Header */
        .header { 
    background: var(--surface); 
    /* This adds padding only if a notch/status bar exists */
    padding: calc(15px + env(safe-area-inset-top)) 15px 15px 15px; 
    position: sticky; 
    top: 0; 
    z-index: 100; 
    border-bottom: 1px solid var(--border); 
}
        
        .header-top { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 10px; 
        }
        
        .header h1 { 
            font-size: 1.3rem; 
            font-weight: 800; 
            color: var(--text-main);
        }
        
        .header h1 span { 
            color: var(--primary); 
        }
        
        .header-actions { 
            display: flex; 
            gap: 8px; 
        }
        
        .icon-btn { 
            background: none; 
            border: none; 
            font-size: 1.3rem; 
            cursor: pointer; 
            padding: 5px; 
            color: var(--text-main);
        }
        
        .add-sample-btn { 
            background: var(--primary); 
            color: white; 
            border: none; 
            padding: 12px 20px; 
            border-radius: 25px; 
            font-weight: 700; 
            font-size: 0.9rem; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            margin-bottom: 10px; 
            width: 100%; 
            justify-content: center; 
            box-shadow: var(--shadow); 
            transition: transform 0.2s; 
        }
        
        .add-sample-btn:active { 
            transform: scale(0.95); 
        }
        
        .search-bar { 
            width: 100%; 
            padding: 10px 15px; 
            border: 1.5px solid var(--border); 
            border-radius: 25px; 
            font-size: 0.9rem; 
            background: var(--bg); 
            color: var(--text-main);
            margin-bottom: 10px;
        }
        
        .container { 
            max-width: 600px; 
            margin: 0 auto; 
            padding: 12px; 
        }
        
        .view-toggle { 
            display: flex; 
            gap: 8px; 
            margin-bottom: 12px; 
        }
        
        .view-btn { 
            flex: 1; 
            padding: 12px 20px; 
            border: 2px solid var(--border); 
            background: var(--surface); 
            border-radius: 25px; 
            font-size: 0.9rem; 
            font-weight: 700; 
            cursor: pointer; 
            transition: all 0.2s; 
            color: var(--text-secondary); 
        }
        
        .view-btn:active { 
            transform: scale(0.95); 
        }
        
        .view-btn.active { 
            background: var(--primary); 
            color: white; 
            border-color: var(--primary); 
        }
        
        .dropdown-panel {
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 10px;
            padding: 12px;
            animation: slideDown 0.2s ease;
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .control-section { 
            background: var(--surface); 
            border-radius: 12px; 
            padding: 15px; 
            margin-bottom: 12px;
            margin-top: 20px;
            box-shadow: var(--shadow); 
            border: 1px solid var(--border); 
        }
        
        .section-title { 
            font-size: 0.75rem; 
            font-weight: 800; 
            text-transform: uppercase; 
            color: var(--text-secondary); 
            margin-bottom: 10px; 
            letter-spacing: 0.5px; 
        }
        
        .filter-btn { 
            padding: 10px 18px; 
            border: 2px solid var(--border); 
            background: var(--surface); 
            border-radius: 25px; 
            font-size: 0.85rem; 
            font-weight: 700; 
            color: var(--text-secondary); 
            white-space: nowrap; 
            cursor: pointer; 
            transition: all 0.2s; 
        }
        
        .filter-btn:active { 
            transform: scale(0.95); 
        }
        
        .filter-btn.active { 
            background: var(--primary); 
            color: white; 
            border-color: var(--primary); 
        }
        
        .batch-bar { 
            position: fixed; 
            bottom: 0; 
            left: 0; 
            right: 0; 
            background: var(--surface); 
            color: var(--text-main); 
            padding: 15px; 
            display: none; 
            justify-content: space-between; 
            align-items: center; 
            z-index: 99; 
            box-shadow: 0 -4px 12px rgba(0,0,0,0.2); 
            border-top: 1px solid var(--border);
        }
        
        .batch-bar.active { 
            display: flex; 
        }
        
        .batch-actions { 
            display: flex; 
            gap: 10px; 
        }
        
        .batch-btn { 
            padding: 8px 16px; 
            border-radius: 8px; 
            border: none; 
            font-weight: 700; 
            cursor: pointer; 
            font-size: 0.85rem; 
        }
        
        .sample-card { 
            background: var(--surface); 
            border-radius: 16px; 
            margin-bottom: 20px; 
            box-shadow: var(--shadow); 
            border: 1px solid var(--border); 
            position: relative; 
        }
        
        .sample-card.selecting { 
            border: 2px solid var(--primary); 
        }
        
        .card-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: flex-start; 
            margin-bottom: 8px; 
        }
        
        .card-checkbox { 
            width: 20px; 
            height: 20px; 
            cursor: pointer; 
        }
        
        .card-body { 
            padding: 16px; 
            position: relative; 
            z-index: 2; 
        }
        
        .brand-name { 
            font-size: 0.75rem; 
            color: var(--text-secondary); 
            font-weight: 700; 
            text-transform: uppercase; 
            letter-spacing: 0.5px; 
        }
        
        .product-name { 
            font-size: 1.1rem; 
            font-weight: 700; 
            color: var(--text-main); 
            margin: 4px 0 8px 0; 
            line-height: 1.2; 
        }
        
        .days-badge { 
            display: inline-block; 
            padding: 4px 10px; 
            border-radius: 12px; 
            font-size: 0.75rem; 
            font-weight: 800; 
            margin-bottom: 10px; 
        }
        
        .days-badge.overdue { background: #FFEBEE; color: var(--red); }
        .days-badge.urgent { background: #FFF8E1; color: var(--yellow); }
        .days-badge.good { background: #E8F5E9; color: var(--green); }
        .days-badge.completed { background: #E0E0E0; color: #666; }
        
        [data-theme="dark"] .days-badge.overdue { background: rgba(255, 59, 48, 0.2); color: #FF6B6B; }
        [data-theme="dark"] .days-badge.urgent { background: rgba(255, 179, 0, 0.2); color: #FFCA28; }
        [data-theme="dark"] .days-badge.good { background: rgba(0, 200, 83, 0.2); color: #69F0AE; }
        [data-theme="dark"] .days-badge.completed { background: #333; color: #aaa; }

        .tags-row { 
            display: flex; 
            gap: 6px; 
            flex-wrap: wrap; 
            margin-bottom: 10px; 
        }
        
        .tag { 
            padding: 3px 8px; 
            border-radius: 8px; 
            font-size: 0.7rem; 
            font-weight: 700; 
            background: #E3F2FD; 
            color: #1976D2; 
        }
        [data-theme="dark"] .tag { background: rgba(33, 150, 243, 0.2); color: #64B5F6; }
        
        .photo-row { 
            display: flex; 
            gap: 8px; 
            margin-bottom: 10px; 
            overflow-x: auto; 
        }
        
        .photo-thumb { 
            width: 60px; 
            height: 60px; 
            object-fit: cover; 
            border-radius: 8px; 
            cursor: pointer; 
        }
        
        .notes-section { 
            background: #FFFDE7; 
            padding: 10px; 
            border-radius: 8px; 
            font-size: 0.85rem; 
            margin-bottom: 10px; 
            border-left: 3px solid var(--yellow); 
            color: #333;
        }
        [data-theme="dark"] .notes-section { background: rgba(255, 255, 255, 0.05); color: #ddd; border-left-color: var(--yellow); }
        
        .checklist {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .progress-toggle {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding: 12px 8px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--surface);
            cursor: pointer;
            transition: all 0.25s ease;
            position: relative;
        }
        
        .progress-toggle:active {
            transform: scale(0.96);
        }
        
        .progress-toggle.active {
            background: linear-gradient(135deg, #00C853 0%, #00E676 100%);
            border-color: #00C853;
            box-shadow: 0 4px 12px rgba(0, 200, 83, 0.3);
        }
        
        .toggle-icon {
            font-size: 1.3rem;
            transition: transform 0.25s ease;
        }
        
        .progress-toggle.active .toggle-icon {
            transform: scale(1.1);
        }
        
        .toggle-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            transition: color 0.25s ease;
        }
        
        .progress-toggle.active .toggle-label {
            color: white;
        }
        
        .toggle-check {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: #00C853;
            font-weight: bold;
            animation: checkPop 0.3s ease;
        }
        
        @keyframes checkPop {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .meta-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 10px; 
            background: var(--bg); 
            padding: 12px; 
            border-radius: 10px; 
            font-size: 0.85rem; 
            margin-bottom: 10px; 
        }
        
        .meta-label { color: var(--text-secondary); font-size: 0.7rem; display: block; margin-bottom: 2px; font-weight: 600; }
        .meta-value { font-weight: 700; color: var(--text-main); }
        
        .progress-container { 
            width: 100%; 
            height: 8px; 
            background: var(--border); 
            border-radius: 4px; 
            margin: 10px 0; 
            overflow: hidden; 
        }
        .progress-fill { height: 100%; transition: width 0.4s ease; }
        
        .action-container { 
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
            margin-top: 10px; 
        }
        
     /* --- Professional Action Buttons --- */
.row-btn { 
    width: 100%; 
    padding: 14px; 
    border-radius: 12px; 
    border: 1px solid transparent; 
    font-weight: 700; 
    font-size: 0.95rem; 
    cursor: pointer; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    text-decoration: none; 
    transition: all 0.2s ease; 
}

/* Edit: Calm Blue */
.sample-card button[onclick*="openModal"] {
    background: #eef7ff !important;
    color: #007aff !important;
    border-color: #d0e7ff !important;
}

/* Delete: Warning Red */
.sample-card button[onclick*="deleteSample"] {
    background: #fff5f5 !important;
    color: #ff3b30 !important;
    border-color: #ffe0e0 !important;
}

/* Product Link: Soft Purple */
.sample-card button[onclick*="openBrowser"] {
    background: #fdf5ff !important;
    color: #9c27b0 !important;
    border-color: #f3e0ff !important;
}

.btn-full-width { background: var(--primary); color: white; }

.btn-completed { 
    background: #f8f9fa; 
    color: #6c757d; 
    border: 1px solid #dee2e6; 
    pointer-events: none; 
    font-style: italic;
}

[data-theme="dark"] .btn-completed { background: #2c2c2c; color: #888; border-color: #444; }

.btn-row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 5px; }

/* Feedback when tapped */
.row-btn:active { 
    transform: scale(0.97); 
    filter: brightness(0.9);
}
        
        .modal { 
            display: none; 
            position: fixed; 
            inset: 0; 
            background: rgba(0,0,0,0.6); 
            backdrop-filter: blur(4px); 
            z-index: 1000; 
            align-items: center; 
            justify-content: center; 
            padding: 20px; 
            overflow-y: auto; 
        }
        .modal.active { display: flex; }
        
        .modal-content { 
            background: var(--surface); 
            width: 100%; 
            max-width: 500px; 
            border-radius: 24px; 
            padding: 24px; 
            max-height: 90vh; 
            overflow-y: auto; 
            margin: auto; 
            color: var(--text-main);
        }
        
        .modal-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 20px; 
        }
        
        .modal-title { font-weight: 800; font-size: 1.3rem; }
        .modal-close { background: none; border: none; font-size: 1.8rem; cursor: pointer; color: var(--text-secondary); }
        
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-weight: 700; font-size: 0.85rem; margin-bottom: 6px; color: var(--text-main); }
        
        .form-input, .form-textarea, .form-select { 
            width: 100%; 
            padding: 12px; 
            border: 1.5px solid var(--border); 
            border-radius: 12px; 
            font-size: 1rem; 
            background: var(--bg); 
            font-family: inherit; 
            color: var(--text-main);
        }
        
        .form-textarea { min-height: 80px; resize: vertical; }
        .form-row { display: flex; gap: 12px; }
        .form-row > div { flex: 1; }
        
        .tags-input-container { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 6px; 
            padding: 8px; 
            border: 1.5px solid var(--border); 
            border-radius: 12px; 
            background: var(--bg); 
            min-height: 45px; 
        }
        
        .tag-input-item { 
            background: #E3F2FD; 
            color: #1976D2; 
            padding: 4px 8px; 
            border-radius: 8px; 
            font-size: 0.8rem; 
            font-weight: 700; 
            display: flex; 
            align-items: center; 
            gap: 5px; 
        }
        
        .tag-remove { cursor: pointer; font-weight: bold; }
        .tag-input-field { border: none; background: none; outline: none; flex: 1; min-width: 100px; font-size: 0.9rem; color: var(--text-main); }
        
        .photo-upload-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        
        .photo-upload-item { 
            position: relative; 
            aspect-ratio: 1; 
            border: 2px dashed var(--border); 
            border-radius: 12px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            overflow: hidden; 
        }
        .photo-upload-item img { width: 100%; height: 100%; object-fit: cover; }
        
        .photo-remove { 
            position: absolute; 
            top: 5px; 
            right: 5px; 
            background: rgba(0,0,0,0.7); 
            color: white; 
            border: none; 
            border-radius: 50%; 
            width: 25px; 
            height: 25px; 
            cursor: pointer; 
            font-weight: bold; 
        }
        
        .due-calc-text { font-size: 0.8rem; color: var(--primary); font-weight: 700; margin-top: 5px; display: block; }
        
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-top: 10px; }
        .calendar-header { text-align: center; font-weight: 700; font-size: 0.7rem; color: var(--text-secondary); padding: 8px 0; }
        
        .calendar-day { 
            aspect-ratio: 1; 
            border: 1px solid var(--border); 
            border-radius: 8px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            font-size: 0.75rem; 
            cursor: pointer; 
            background: var(--surface); 
            position: relative; 
            color: var(--text-main);
        }
        .calendar-day.other-month { color: #CCC; }
        [data-theme="dark"] .calendar-day.other-month { color: #555; }
        
        .calendar-day.has-items { background: #FFF3E0; border-color: var(--yellow); }
        [data-theme="dark"] .calendar-day.has-items { background: rgba(255, 179, 0, 0.1); }
        
        .calendar-day.has-items.overdue { background: #FFEBEE; border-color: var(--red); }
        [data-theme="dark"] .calendar-day.has-items.overdue { background: rgba(255, 59, 48, 0.1); }
        
        .calendar-day-number { font-weight: 700; }
        .calendar-day-dots { display: flex; gap: 2px; margin-top: 2px; }
        .calendar-dot { width: 4px; height: 4px; border-radius: 50%; }
        
        .analytics-section { background: var(--surface); border-radius: 16px; padding: 20px; margin-bottom: 15px; box-shadow: var(--shadow); }
        .analytics-title { font-weight: 800; font-size: 1.1rem; margin-bottom: 15px; }
        .analytics-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .analytics-card { text-align: center; padding: 15px; background: var(--bg); border-radius: 12px; }
        .analytics-number { font-size: 1.8rem; font-weight: 800; color: var(--primary); }
        .analytics-label { font-size: 0.75rem; color: var(--text-secondary); font-weight: 600; margin-top: 5px; }
        
        .empty-state { text-align: center; padding: 60px 20px; color: #BBB; }
        
        .browser-overlay { display: none; position: fixed; inset: 0; background: white; z-index: 2000; flex-direction: column; }
        .browser-overlay.active { display: flex; }
        .browser-header { background: var(--primary); color: white; padding: 15px; display: flex; align-items: center; justify-content: space-between; }
        .browser-close { background: none; border: none; color: white; font-size: 1.5rem; font-weight: bold; cursor: pointer; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }
        .browser-title { font-size: 0.9rem; font-weight: 600; flex: 1; text-align: center; }
        .browser-frame { flex: 1; border: none; width: 100%; }
        
        .collapsible-section { margin-bottom: 15px; }
        .collapsible-header { background: var(--surface); padding: 15px; border-radius: 12px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 700; border: 1px solid var(--border); }
        .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.3s; }
        .collapsible-content.active { max-height: 5000px; }
        
        /* Toggle Switch */
        .switch { position: relative; display: inline-block; width: 50px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--green); }
        input:checked + .slider:before { transform: translateX(26px); }

        .pro-badge {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: white;
            padding: 2px 8px;
            border-radius: 6px;
            font-size: 0.65rem;
            font-weight: 800;
            margin-left: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        @keyframes loading {
            0%, 100% { transform: translateX(-100%); }
            50% { transform: translateX(100%); }
        }
        /* Floating Install Button */
#floatingInstallBtn {
    position: fixed;
    bottom: 90px;
    right: 20px;
    background: linear-gradient(135deg, #FE2C55, #FF6B8A);
    color: white;
    padding: 15px 20px;
    border-radius: 50px;
    font-weight: 700;
    font-size: 0.9rem;
    box-shadow: 0 4px 20px rgba(254, 44, 85, 0.4);
    cursor: pointer;
    z-index: 9999;
    border: none;
    animation: pulse 2s infinite;
}

        /* Hide the install button when running as an installed PWA */
@media (display-mode: standalone), (display-mode: minimal-ui) {
    #floatingInstallBtn {
        display: none !important;
    }
}


@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}

#floatingInstallBtn:active {
    transform: scale(0.95);
}
  
    /* In-App Notification Banner */
.notification-banner {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: linear-gradient(135deg, #FF3B30 0%, #FF6B6B 100%);
    color: white;
    padding: calc(15px + env(safe-area-inset-top)) 15px 15px 15px;
    z-index: 9999;
    display: none;
    align-items: center;
    justify-content: space-between;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    animation: slideDownBanner 0.3s ease;
}

.notification-banner.active {
    display: flex;
}

.notification-banner.urgent {
    background: linear-gradient(135deg, #FFB300 0%, #FFC107 100%);
}

.notification-banner.good {
    background: linear-gradient(135deg, #00C853 0%, #69F0AE 100%);
}

@keyframes slideDownBanner {
    from { transform: translateY(-100%); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

.banner-content {
    display: flex;
    align-items: center;
    gap: 12px;
    flex: 1;
}

.banner-icon {
    font-size: 1.5rem;
    flex-shrink: 0;
}

.banner-text {
    flex: 1;
}

.banner-title {
    font-weight: 700;
    font-size: 0.95rem;
    margin-bottom: 2px;
}

.banner-subtitle {
    font-size: 0.8rem;
    opacity: 0.9;
}

.banner-dismiss {
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    font-size: 1.2rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    transition: background 0.2s;
}

.banner-dismiss:hover {
    background: rgba(255,255,255,0.3);
}

.banner-action {
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    cursor: pointer;
    margin-left: 10px;
    flex-shrink: 0;
}

/* Flashing banner for due today */
@keyframes flashBanner {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

.notification-banner.flash {
    animation: flashBanner 1s ease-in-out 3;
}

        
    
    
    </style>
</head>
<body>
   <!-- In-App Notification Banner -->
<div id="notificationBanner" class="notification-banner">
    <div class="banner-content">
        <span class="banner-icon" id="bannerIcon">üîî</span>
        <div class="banner-text">
            <div class="banner-title" id="bannerTitle">Items Due Today</div>
            <div class="banner-subtitle" id="bannerSubtitle">You have samples that need attention</div>
            <div class="banner-details" id="bannerDetails" style="font-size: 0.75rem; margin-top: 4px; opacity: 0.9;"></div>
        </div>
    </div>
    <button class="banner-action" onclick="scrollToFilter('overdue')">View</button>
    <button class="banner-dismiss" onclick="dismissNotificationBanner()">√ó</button>
</div>
    
    <!-- Floating Install Button -->
<button
    id="floatingInstallBtn"
    class="floatingInstallBtn"
    onclick="installApp()"
>
    üì± Install App
    <span
      style="margin-left: 8px; font-size: 0.9rem;"
      onclick="event.stopPropagation(); dismissInstallButton();"
    >
      ‚úï
    </span>
</button>

    <div id="landingPage">
        <div class="landing-content">
            <div class="app-icon">
                <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <rect x="10" y="15" width="80" height="75" rx="5" fill="#FE2C55" opacity="0.1"/>
                    <rect x="15" y="5" width="70" height="10" rx="3" fill="#FE2C55"/>
                    <rect x="20" y="25" width="10" height="10" rx="2" fill="#00C853"/>
                    <path d="M 22 30 L 25 33 L 28 27" stroke="white" stroke-width="2" fill="none"/>
                    <rect x="35" y="26" width="45" height="3" rx="1.5" fill="#E0E0E0"/>
                    <rect x="20" y="42" width="10" height="10" rx="2" fill="#00C853"/>
                    <path d="M 22 47 L 25 50 L 28 44" stroke="white" stroke-width="2" fill="none"/>
                    <rect x="35" y="43" width="40" height="3" rx="1.5" fill="#E0E0E0"/>
                    <rect x="20" y="59" width="10" height="10" rx="2" fill="white" stroke="#E0E0E0" stroke-width="1"/>
                    <rect x="35" y="60" width="50" height="3" rx="1.5" fill="#E0E0E0"/>
                    <rect x="20" y="76" width="10" height="10" rx="2" fill="white" stroke="#E0E0E0" stroke-width="1"/>
                    <rect x="35" y="77" width="35" height="3" rx="1.5" fill="#E0E0E0"/>
                </svg>
            </div>
            
            <h1 class="landing-title">SampleFlow</h1>
            <p class="landing-subtitle">Never miss a deadline again. Track your brand collaborations, get reminders, and stay organized.</p>
            
            <div class="landing-features">
                <div class="feature-item">
                    <div class="feature-icon">üì¶</div>
                    <div>Track all your samples in one place</div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">‚è∞</div>
                    <div>View stages and sort</div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">‚òÅÔ∏è</div>
                    <div>Cloud sync across all your devices</div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">üìä</div>
                    <div>Calendar view and analytics</div>
                </div>
            </div>
        </div>

        <div class="landing-sticky-bar">
            <button class="landing-btn btn-primary" onclick="showAuth('signup')">Create Free Account</button>
            <button class="landing-btn btn-secondary" onclick="showAuth('signin')">Sign In</button>
            
            <div class="landing-links">
                <a href="#" class="landing-link" onclick="showPrivacyFromLanding(); return false;">Privacy Policy</a>
                <a href="#" class="landing-link" onclick="showHelpFromLanding(); return false;">Help</a>
            </div>
        </div>
    </div>

    <div id="appContainer">
        <div class="header"> 
    <div class="header-top"> 
        <a href="https://lazybstudios.com" style="text-decoration: none; color: inherit; cursor: pointer;">
            <h1><span>Sample</span>Flow</h1>
        </a>
        <div class="header-actions">
                    <button class="icon-btn" onclick="openAnalytics()" title="Analytics">üìä</button>
                    <button class="icon-btn" onclick="toggleMenu()" title="Menu">‚ãÆ</button>
                </div>
            </div>
            <button class="add-sample-btn" onclick="openModal()">
                <span style="font-size: 1.2rem;">+</span>
                <span>Add New Sample</span>
            </button>
            
            <input type="text" class="search-bar" id="searchBar" placeholder="Search brands or products..." oninput="handleSearch()">
            
            <div style="display: flex; justify-content: center; gap: 8px; margin-bottom: 12px;">
    <button class="progress-toggle active" id="view-list" onclick="setView('list')" style="flex: 1; max-width: 80px;">
        <span class="toggle-icon">üìã</span>
        <span class="toggle-label">List</span>
    </button>
    <button class="progress-toggle" id="view-calendar" onclick="setView('calendar')" style="flex: 1; max-width: 80px;">
        <span class="toggle-icon">üìÖ</span>
        <span class="toggle-label">Calendar</span>
    </button>
    <button class="progress-toggle active" id="expandedViewBtn" onclick="setCardView('expanded')" style="flex: 1; max-width: 80px;">
        <span class="toggle-icon">üìÇ</span>
        <span class="toggle-label">Full</span>
    </button>
    <button class="progress-toggle" id="condensedViewBtn" onclick="setCardView('condensed')" style="flex: 1; max-width: 80px;">
        <span class="toggle-icon">üìÑ</span>
        <span class="toggle-label">Compact</span>
    </button>
</div>

<div class="view-toggle" style="margin-top: 12px;">
    <button class="view-btn" id="filterToggleBtn" onclick="toggleFilterDropdown()">üîç Filter</button>
    <button class="view-btn" id="sortToggleBtn" onclick="toggleSortDropdown()">üìä Sort</button>
</div>
            
            <div id="filterDropdown" class="dropdown-panel" style="display: none; margin-top: 8px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                    <button class="filter-btn active" id="f-all" onclick="setFilter('all')">üì¶ All (<span id="statAll">0</span>)</button>
                    <button class="filter-btn" id="f-overdue" onclick="setFilter('overdue')">üî• Overdue (<span id="statOverdue">0</span>)</button>
                    <button class="filter-btn" id="f-urgent" onclick="setFilter('urgent')">‚è≥ Due Soon (<span id="statUrgent">0</span>)</button>
                    <button class="filter-btn" id="f-good" onclick="setFilter('good')">‚úÖ On Track (<span id="statGood">0</span>)</button>
                    <button class="filter-btn" id="f-completed" onclick="setFilter('completed')">üèÅ Posted (<span id="statCompleted">0</span>)</button>
                </div>
            </div>
            
            <div id="sortDropdown" class="dropdown-panel" style="display: none; margin-top: 8px;">
                <button class="filter-btn" onclick="setSort('dueDate')">üìÖ Due Date</button>
                <button class="filter-btn" onclick="setSort('brand')">üè∑Ô∏è Brand Name</button>
                <button class="filter-btn" onclick="setSort('received')">üì¶ Received Date</button>
            </div>
                     
            <div id="filterHeading" style="position: sticky; top: 0; z-index: 50; background: var(--bg); padding: 12px 15px; margin: 0 -15px; font-weight: 700; font-size: 1.1rem; color: var(--text-main); border-bottom: 2px solid var(--border); display: none;">
                üì¶ All Samples
            </div>
        </div>
        
        <div class="container">
            <div id="listView">
                <div id="sampleGrid"></div>
            </div>

            <div id="calendarView" style="display:none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <button class="icon-btn" onclick="changeMonth(-1)">‚óÄ</button>
                    <h2 id="calendarMonth" style="font-weight: 800;"></h2>
                    <button class="icon-btn" onclick="changeMonth(1)">‚ñ∂</button>
                </div>
                <div class="calendar-grid" id="calendarGrid"></div>
                <div id="calendarDayDetails" style="margin-top: 20px;"></div>
            </div>
        </div>
    </div>

    <div class="batch-bar" id="batchBar">
        <div>
            <strong><span id="selectedCount">0</span> selected</strong>
        </div>
        <div class="batch-actions">
            <button class="batch-btn" style="background: var(--green); color: white;" onclick="batchMarkDone()">üèÅ Archive Selected</button>
            <button class="batch-btn" style="background: var(--red); color: white;" onclick="batchDelete()">üóë Delete</button>
            <button class="batch-btn" style="background: white; color: var(--dark);" onclick="clearSelection()">Cancel</button>
        </div>
    </div>

    <div id="menuModal" class="modal">
        <div class="modal-content" style="max-width: 300px;">
            <div class="modal-header">
                <h2 class="modal-title">Menu</h2>
                <button class="modal-close" onclick="closeMenu()">√ó</button>
            </div>
            <div style="display: flex; flex-direction: column; gap: 10px;">
                              
                <button class="row-btn btn-secondary" id="manageSubBtn" onclick="manageSubscription(); closeMenu()" style="display: none; background: linear-gradient(135deg, #FFD700, #FFA500); color: white; border: none; font-weight: 700;">
                    ‚≠ê Manage Subscription
                </button>
                <button class="row-btn btn-secondary" onclick="openBetaFeedback(); closeMenu();" style="display: none;">üß™ Beta Feedback</button>
                <button class="row-btn btn-secondary" onclick="openSettings(); closeMenu()">‚öôÔ∏è Settings</button>
                <button class="row-btn btn-secondary" id="installBtnMenu" onclick="installApp(); closeMenu()" style="display: none;">üì≤ Install App</button>
                <button class="row-btn btn-secondary" onclick="openSupport(); closeMenu()">üí¨ Contact Support</button>
                <button class="row-btn btn-secondary" onclick="openHelp(); closeMenu()">‚ùì Help</button>
                <button class="row-btn btn-secondary" onclick="window.open('privacy.html', '_blank'); closeMenu()">üîí Privacy Policy</button>
                <button class="row-btn btn-secondary" onclick="window.open('terms.html', '_blank'); closeMenu()">üìÑ Terms of Service</button>
                <button class="row-btn btn-secondary" id="menuSignOutBtn" onclick="signOut(); closeMenu()" style="display: none; background: var(--red); color: white; border-color: var(--red); margin-top: 10px;">üö™ Sign Out</button>
            </div>
        </div>
    </div>

    <div id="sampleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Add Sample</h2>
                <button class="modal-close" onclick="closeModal()">√ó</button>
            </div>
            <form id="sampleForm" onsubmit="handleSave(event)">
                <div class="form-group">
                    <label class="form-label">Product Name</label>
                    <input type="text" id="productName" class="form-input" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Brand</label>
                    <input type="text" id="brandName" class="form-input" required>
                </div>
                
                <div class="form-row">
                    <div>
                        <label class="form-label">Received Date</label>
                        <input type="date" id="dateReceived" class="form-input" required onchange="calcDuePreview()">
                    </div>
                    <div>
                        <label class="form-label">Days to Post</label>
                        <input type="number" id="daysLimit" class="form-input" value="14" oninput="calcDuePreview()">
                    </div>
                </div>
                <span id="dueCalcDisplay" class="due-calc-text"></span>

               <div style="display: none;"> <div class="form-group">
                    <label class="form-label">Reminder Settings</label>
                    <select id="sampleReminderDays" class="form-input">
                        <option value="">Use default reminder (from Settings)</option>
                        <option value="0">Remind me on due date</option>
                        <option value="1">Remind me 1 day before</option>
                        <option value="2">Remind me 2 days before</option>
                        <option value="3">Remind me 3 days before</option>
                        <option value="5">Remind me 5 days before</option>
                        <option value="7">Remind me 7 days before</option>
                    </select>
               </div>
                    </div>

                <div class="form-group">
                    <label class="form-label">Product Link (Optional)</label>
                    <input type="url" id="shopLink" class="form-input" placeholder="Paste product link here">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Tags (press Enter to add)</label>
                    <div class="tags-input-container" id="tagsContainer" onclick="document.getElementById('tagInput').focus()">
                        <input type="text" id="tagInput" class="tag-input-field" placeholder="Add tag..." onkeydown="handleTagInput(event)">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea id="notes" class="form-textarea" placeholder="Add any notes or reminders..."></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Photos</label>
                    <div class="photo-upload-grid" id="photoGrid">
                        <label class="photo-upload-item">
                            <input type="file" accept="image/*" style="display:none" onchange="handlePhotoUpload(event)">
                            <span style="font-size: 2rem;">+</span>
                        </label>
                    </div>
                </div>
                
               <div style="display: flex; gap: 10px;">
    <button type="button" class="row-btn btn-secondary" style="flex: 1;" onclick="closeModal()">Cancel</button>
    <button type="submit" class="row-btn btn-full-width" style="flex: 2;">Save Sample</button>
</div>
            </form>
        </div>
    </div>

    <div id="analyticsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üìä Analytics</h2>
                <button class="modal-close" onclick="closeAnalytics()">√ó</button>
            </div>
            <div id="analyticsContent"></div>
        </div>
    </div>

    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">‚öôÔ∏è Settings</h2>
                <button class="modal-close" onclick="closeSettings()">√ó</button>
            </div>
            
            <div class="form-group">
                <label class="form-label">Account</label>
                <div id="cloudStatus" style="padding: 15px; background: var(--bg); border-radius: 12px; text-align: center; color: var(--text-secondary); margin-bottom: 10px;">
                    <p style="margin-bottom: 5px; font-weight: 700;">üíæ Using Local Storage</p>
                    <p style="font-size: 0.85rem;">Your data is saved in your browser</p>
                </div>
                <button class="row-btn btn-secondary" onclick="showCloudInfo()" style="background: var(--green); color: white; border-color: var(--green); margin-bottom: 10px;">‚ÑπÔ∏è Cloud Storage Info</button>
            </div>
            
            <div class="form-group">
                <div style="padding: 15px; background: var(--bg); border-radius: 12px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <span style="font-weight: 600;">üåô Dark Mode</span>
                    <label class="switch">
                        <input type="checkbox" id="darkModeToggle" onchange="toggleTheme(this.checked)">
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div style="padding: 15px; background: var(--bg); border-radius: 12px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <span style="font-weight: 600;">üì≥ Haptic Feedback</span>
                    <label class="switch">
                        <input type="checkbox" id="hapticToggle" onchange="toggleHaptic(this.checked)">
                        <span class="slider"></span>
                    </label>
                </div>

                <div style="padding: 15px; background: var(--bg); border-radius: 12px; display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-weight: 600;">üì± Compact Mode</span>
                    <label class="switch">
                        <input type="checkbox" id="compactToggle" onchange="toggleCompact(this.checked)">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
            <div style="display: none;">
            <div class="form-group">
                <label class="form-label">Reminder Notifications</label>
                <div style="padding: 15px; background: var(--bg); border-radius: 12px; margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <span style="font-weight: 600;">üîî Push Notifications</span>
                        <label class="switch">
                            <input type="checkbox" id="notificationsToggle" onchange="toggleNotifications(this.checked)">
                            <span class="slider"></span>
                        </label>
                     </div>  
                    <p style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 12px;">Get reminders when samples are due soon</p>
                    
                    <div id="reminderSettings" style="display: none;">
                        <label class="form-label" style="font-size: 0.8rem; margin-bottom: 5px;">Remind me when samples are:</label>
                        <select id="reminderDays" class="form-input" onchange="saveReminderSettings()" style="padding: 8px; font-size: 0.85rem;">
                            <option value="0">Due today</option>
                            <option value="1" selected>Due in 1 day</option>
                            <option value="2">Due in 2 days</option>
                            <option value="3">Due in 3 days</option>
                            <option value="5">Due in 5 days</option>
                            <option value="7">Due in 7 days</option>
                        </select>
                    </div>
                </div>
                <div id="notificationStatus" style="font-size: 0.75rem; color: var(--text-secondary); padding: 10px; background: #FFF8E1; border-radius: 8px; display: none;">
                    Click "Allow" when your browser asks for permission
                </div>
            </div>
                </div>
<div style="display: none;">
    <div class="form-group">
        <label class="form-label">Reminder Notifications</label>
        <div style="padding: 15px; background: var(--bg); border-radius: 12px; margin-bottom: 10px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <span style="font-weight: 600;">üîî Push Notifications</span>
                <label class="switch">
                    <input type="checkbox" id="notificationsToggle" onchange="toggleNotifications(this.checked)">
                    <span class="slider"></span>
                </label>
             </div>  
            <p style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 12px;">Get reminders when samples are due soon</p>
            
            <div id="reminderSettings" style="display: none;">
                <label class="form-label" style="font-size: 0.8rem; margin-bottom: 5px;">Remind me when samples are:</label>
                <select id="reminderDays" class="form-input" onchange="saveReminderSettings()" style="padding: 8px; font-size: 0.85rem;">
                    <option value="0">Due today</option>
                    <option value="1" selected>Due in 1 day</option>
                    <option value="2">Due in 2 days</option>
                    <option value="3">Due in 3 days</option>
                    <option value="5">Due in 5 days</option>
                    <option value="7">Due in 7 days</option>
                </select>
            </div>
        </div>
        <div id="notificationStatus" style="font-size: 0.75rem; color: var(--text-secondary); padding: 10px; background: #FFF8E1; border-radius: 8px; display: none;">
            Click "Allow" when your browser asks for permission
        </div>
    </div>
</div>

<!-- NEW: In-App Banner Notification Toggle -->
<div class="form-group">
    <label class="form-label">Notifications</label>
    <div style="padding: 15px; background: var(--bg); border-radius: 12px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <span style="font-weight: 600;">üîî Due Date Reminders</span>
            <label class="switch">
                <input type="checkbox" id="bannerNotificationsToggle" onchange="toggleBannerNotifications(this.checked)" checked>
                <span class="slider"></span>
            </label>
        </div>
        <p style="font-size: 0.8rem; color: var(--text-secondary);">Show a banner when you have samples due or overdue</p>
    </div>
</div>

           
            <div class="form-group">
                <label class="form-label">Default Days to Post</label>
                <input type="number" id="defaultDays" class="form-input" value="14" onchange="saveSettings()">
            </div>

            <div class="form-group" style="margin-top: 20px; border-top: 1px solid var(--border); padding-top: 20px;">
                <label class="form-label">Account Information</label>
                
                <div style="padding: 15px; background: var(--bg); border-radius: 12px; margin-bottom: 10px;">
                    <div style="margin-bottom: 8px;">
                        <span style="font-size: 0.75rem; color: var(--text-secondary); display: block;">Email Address</span>
                        <span id="settingsEmailDisplay" style="font-weight: 600; color: var(--text-main);">Not signed in</span>
                    </div>
                    <div style="margin-bottom: 8px;">
                        <span style="font-size: 0.75rem; color: var(--text-secondary); display: block;">Account Tier</span>
                        <span id="settingsTierDisplay" style="font-weight: 600; color: var(--text-main); text-transform: capitalize;">Free</span>
                    </div>
                </div>
                
                <button class="row-btn btn-secondary" onclick="openChangeEmail()" style="margin-bottom: 10px;">üìß Change Email</button>
                <button class="row-btn btn-secondary" onclick="openChangePassword()" style="margin-bottom: 10px;">üîí Change Password</button>
                <button class="row-btn btn-secondary" onclick="openDeleteAccountModal()" style="color: var(--red); border-color: var(--red); margin-bottom: 10px;">üóëÔ∏è Delete Account</button>
            </div>

            <div class="form-group" style="margin-top: 20px; border-top: 1px solid var(--border); padding-top: 20px;">
                <label class="form-label">Data Management</label>
                <button class="row-btn btn-secondary" onclick="exportCSV(); closeSettings();" style="margin-bottom: 10px;">üì• Export to CSV</button>
                <button class="row-btn btn-secondary" onclick="importData(); closeSettings();" style="margin-bottom: 10px;">üìÅ Import Data</button>
                <button class="row-btn btn-secondary" onclick="clearCompleted(); closeSettings();">üßπ Clear Completed Samples</button>
            </div>

            <div class="form-group" style="margin-top: 30px; border-top: 1px solid var(--border); padding-top: 20px;">
                <label class="form-label" style="color: var(--red);">Danger Zone</label>
                <button class="row-btn btn-secondary" onclick="openResetModal()" style="color: var(--red); border-color: var(--red);">‚ö†Ô∏è Reset App Data</button>
            </div>
        </div>
    </div>

    <div id="resetModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" style="color: var(--red);">‚ö†Ô∏è Reset App?</h2>
                <button class="modal-close" onclick="closeResetModal()">√ó</button>
            </div>
            <p style="margin-bottom: 20px;">This will <strong>delete all local data</strong> and reset your settings. If you are logged in, your cloud data will remain safe, but you will be signed out.</p>
            <p style="margin-bottom: 20px; font-weight: bold;">This action cannot be undone.</p>
            <button class="row-btn btn-full-width" style="background: var(--red); margin-bottom: 10px;" onclick="confirmReset()">Yes, Reset Everything</button>
            <button class="row-btn btn-secondary" onclick="closeResetModal()">Cancel</button>
        </div>
    </div>

    <!-- Delete Account Modal -->
    <div id="deleteAccountModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title" style="color: var(--red);">‚ö†Ô∏è Delete Account</h2>
                <button class="modal-close" onclick="closeDeleteAccountModal()">√ó</button>
            </div>
            
            <div style="background: #FFEBEE; padding: 15px; border-radius: 12px; border-left: 4px solid var(--red); margin-bottom: 20px;">
                <p style="font-weight: 700; color: var(--red); margin-bottom: 10px;">‚ö†Ô∏è WARNING: This action cannot be undone!</p>
                <p style="color: #333; font-size: 0.9rem;">Deleting your account will permanently:</p>
                <ul style="margin: 10px 0 0 20px; color: #333; font-size: 0.9rem;">
                    <li>Delete all your samples and data</li>
                    <li>Remove all photos and notes</li>
                    <li>Cancel any active subscriptions</li>
                    <li>Sign you out immediately</li>
                </ul>
            </div>
            
            <p style="margin-bottom: 20px; font-weight: 600;">Please type <strong style="color: var(--red);">DELETE</strong> to confirm:</p>
            
            <div class="form-group">
                <input type="text" id="deleteConfirmInput" class="form-input" placeholder="Type DELETE to confirm" style="text-transform: uppercase;">
            </div>
            
            <div id="deleteAccountError" style="color: var(--red); font-size: 0.85rem; margin-bottom: 10px; display: none;"></div>
            
            <button class="row-btn btn-full-width" style="background: var(--red); margin-bottom: 10px;" onclick="confirmDeleteAccount()">Delete My Account</button>
            <button class="row-btn btn-secondary" onclick="closeDeleteAccountModal()">Cancel</button>
        </div>
    </div>

    <!-- Change Email Modal -->
    <div id="changeEmailModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2 class="modal-title">üìß Change Email</h2>
                <button class="modal-close" onclick="closeChangeEmail()">√ó</button>
            </div>
            
            <div style="background: #FFF8E1; padding: 12px; border-radius: 8px; margin-bottom: 15px; font-size: 0.85rem; color: #666;">
                ‚ÑπÔ∏è You'll need to verify your new email address
            </div>
            
            <div class="form-group">
                <label class="form-label">Current Email</label>
                <input type="email" id="currentEmailDisplay" class="form-input" disabled style="background: var(--bg); color: var(--text-secondary);">
            </div>
            
            <div class="form-group">
                <label class="form-label">New Email</label>
                <input type="email" id="newEmail" class="form-input" placeholder="your-new-email@example.com">
            </div>
            
            <div class="form-group">
                <label class="form-label">Confirm Password</label>
                <div style="position: relative;">
                    <input type="password" id="emailChangePassword" class="form-input" placeholder="Enter your password" style="padding-right: 45px;">
                    <button type="button" onclick="togglePasswordVisibility('emailChangePassword', this)" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 1.2rem;">üëÅÔ∏è</button>
                </div>
            </div>
            
            <div id="changeEmailError" style="color: var(--red); font-size: 0.85rem; margin-bottom: 10px; display: none;"></div>
            
            <button class="row-btn btn-full-width" onclick="handleChangeEmail()">Change Email</button>
        </div>
    </div>

    <div id="cloudInfoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üì¶ Cloud Storage Info</h2>
                <button class="modal-close" onclick="closeCloudInfo()">√ó</button>
            </div>
            <div style="line-height: 1.6; color: var(--text-secondary);">
                <div style="background: #E8F5E9; padding: 20px; border-radius: 12px; border-left: 3px solid var(--green); margin-bottom: 15px;">
                    <h3 style="font-weight: 700; margin-bottom: 10px; color: var(--green);">‚úì Cloud Storage with Multi-Device Sync!</h3>
                    <p style="font-size: 0.9rem; color: #333;">Your account syncs automatically across all your devices. Sign in on any phone, tablet, or computer to access your samples.</p>
                </div>
                
                <h3 style="font-weight: 700; margin-bottom: 10px; color: var(--text-main);">How It Works</h3>
                <ul style="margin-bottom: 15px; padding-left: 20px;">
                    <li>Create one account with your email and password</li>
                    <li>Sign in on any device to see all your samples</li>
                    <li>Changes sync instantly across all devices</li>
                    <li>Your data is encrypted and secure</li>
                </ul>
            </div>
        </div>
    </div>

    <div id="privacyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üîí Privacy Policy</h2>
                <button class="modal-close" onclick="closePrivacy()">√ó</button>
            </div>
            <div style="line-height: 1.6; color: var(--text-secondary);">
                <h3 style="font-weight: 700; margin-bottom: 10px; color: var(--text-main);">Data Storage</h3>
                <p style="margin-bottom: 15px;">Your data is stored securely in the cloud using Supabase. We do not share your information with third parties.</p>
                
                <h3 style="font-weight: 700; margin-bottom: 10px; color: var(--text-main);">What We Store</h3>
                <ul style="margin-bottom: 15px; padding-left: 20px;">
                    <li>Product and brand information</li>
                    <li>Dates and deadlines</li>
                    <li>Notes and tags you create</li>
                    <li>Photos you upload</li>
                    <li>Your app settings and preferences</li>
                </ul>
                
                <h3 style="font-weight: 700; margin-bottom: 10px; color: var(--text-main);">Your Control</h3>
                <p style="margin-bottom: 15px;">You have full control over your data. You can export it as CSV, delete individual items, or delete your entire account.</p>
            </div>
        </div>
    </div>

    <div id="supportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üí¨ Contact Support</h2>
                <button class="modal-close" onclick="closeSupport()">√ó</button>
            </div>
            <div style="line-height: 1.6; text-align: center;">
                <div style="background: linear-gradient(135deg, #FE2C55 0%, #FF6B8A 100%); padding: 40px; border-radius: 16px; margin-bottom: 25px; color: white;">
                    <div style="font-size: 4rem; margin-bottom: 15px;">üìß</div>
                    <h3 style="font-weight: 700; margin-bottom: 15px; font-size: 1.3rem;">Need Help?</h3>
                    <p style="font-size: 1rem; opacity: 0.95; margin-bottom: 25px;">Click below to email our support team</p>
                    <a href="mailto:support@lazybstudios.com?subject=SampleFlow Support Request" style="display: inline-block; background: white; color: var(--primary); padding: 15px 30px; border-radius: 30px; font-weight: 700; text-decoration: none; font-size: 1.1rem; box-shadow: 0 4px 12px rgba(0,0,0,0.2);">
                        üìß Email Support
                    </a>
                </div>

                <div style="background: #E3F2FD; padding: 20px; border-radius: 12px; text-align: left;">
                    <p style="font-size: 0.9rem; color: #666; margin-bottom: 8px;">
                        <strong style="color: var(--dark);">Email:</strong> <a href="mailto:support@lazybstudios.com">support@lazybstudios.com</a>
                    </p>
                    <p style="font-size: 0.9rem; color: #666;">
                        <strong style="color: var(--dark);">Response Time:</strong> We typically respond within 24 hours on weekdays
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div id="changePasswordModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2 class="modal-title">üîí Change Password</h2>
                <button class="modal-close" onclick="closeChangePassword()">√ó</button>
            </div>
            <div class="form-group">
                <label class="form-label">New Password</label>
                <div style="position: relative;">
                    <input type="password" id="newPassword" class="form-input" placeholder="Min 6 characters" style="padding-right: 45px;">
                    <button type="button" onclick="togglePasswordVisibility('newPassword', this)" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 1.2rem;">üëÅÔ∏è</button>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Confirm New Password</label>
                <div style="position: relative;">
                    <input type="password" id="confirmNewPassword" class="form-input" placeholder="Confirm password" style="padding-right: 45px;">
                    <button type="button" onclick="togglePasswordVisibility('confirmNewPassword', this)" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 1.2rem;">üëÅÔ∏è</button>
                </div>
            </div>
            <div id="changePasswordError" style="color: var(--red); font-size: 0.85rem; margin-bottom: 10px; display: none;"></div>
            <button class="row-btn btn-full-width" onclick="handleChangePassword()">Update Password</button>
        </div>
    </div>

    <!-- Help Modal -->
<div id="helpModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">üí° Help & Guide</h2>
            <button class="modal-close" onclick="closeHelp()">√ó</button>
        </div>
        
        <div style="max-height: 500px; overflow-y: auto; padding-right: 10px;">
            
            <!-- Getting Started -->
            <div style="margin-bottom: 25px;">
                <h3 style="color: var(--primary); margin-bottom: 12px; font-size: 1.1rem;">üöÄ Getting Started</h3>
                <div style="background: var(--surface); padding: 15px; border-radius: 8px; border-left: 3px solid var(--primary);">
                    <p style="margin-bottom: 8px;"><strong>Add a Sample:</strong> Tap the + button, enter brand name, product, and posting deadline.</p>
                    <p style="margin-bottom: 8px;"><strong>Track Progress:</strong> Check off tasks as you film, edit, and post content.</p>
                    <p style="margin-bottom: 0;"><strong>Mark Complete:</strong> Simply tap the üì± Posted icon in the checklist to automatically archive your sample.</p>
                </div>
            </div>
            
            <!-- Pro Features -->
            <div style="margin-bottom: 25px;">
                <h3 style="color: var(--primary); margin-bottom: 12px; font-size: 1.1rem;">‚≠ê Pro Features</h3>
                <div style="background: var(--surface); padding: 15px; border-radius: 8px; border-left: 3px solid var(--primary);">
                    <p style="margin-bottom: 8px;"><strong>üì± Ready to Film:</strong> One-tap access to TikTok camera. Returns you to the app with back button (2 taps).</p>
                    <p style="margin-bottom: 8px;"><strong>‚ú® AI Script Generator:</strong> Get custom TikTok scripts written for each product (5 per day).</p>
                    <p style="margin-bottom: 8px;"><strong>üì∏ Photo Attachments:</strong> Add unlimited product photos to each sample.</p>
                    <p style="margin-bottom: 8px;"><strong>üìä Export CSV:</strong> Download all your data as a spreadsheet.</p>
                    <p style="margin-bottom: 0;"><strong>‚òÅÔ∏è Cloud Sync:</strong> Access your samples on any device automatically.</p>
                </div>
            </div>
            
            <!-- Account Management -->
            <div style="margin-bottom: 25px;">
                <h3 style="color: var(--primary); margin-bottom: 12px; font-size: 1.1rem;">üë§ Account Management</h3>
                <div style="background: var(--surface); padding: 15px; border-radius: 8px; border-left: 3px solid var(--primary);">
                    <p style="margin-bottom: 8px;"><strong>Settings ‚Üí Account Info:</strong> View your email and subscription tier.</p>
                    <p style="margin-bottom: 8px;"><strong>Change Email:</strong> Update your email address (requires password confirmation).</p>
                    <p style="margin-bottom: 8px;"><strong>Change Password:</strong> Request a password reset link via email.</p>
                    <p style="margin-bottom: 0;"><strong>Delete Account:</strong> Permanently remove all your data and account access.</p>
                </div>
            </div>
            
            <!-- Status Indicators -->
            <div style="margin-bottom: 25px;">
                <h3 style="color: var(--primary); margin-bottom: 12px; font-size: 1.1rem;">üö¶ Status Indicators</h3>
                <div style="background: var(--surface); padding: 15px; border-radius: 8px; border-left: 3px solid var(--primary);">
                    <p style="margin-bottom: 8px;"><span style="color: var(--red); font-weight: 600;">‚óè Overdue:</span> Posting deadline has passed</p>
                    <p style="margin-bottom: 8px;"><span style="color: var(--orange); font-weight: 600;">‚óè Due Soon:</span> Less than 7 days remaining</p>
                    <p style="margin-bottom: 8px;"><span style="color: var(--green); font-weight: 600;">‚óè On Track:</span> 7+ days remaining</p>
                    <p style="margin-bottom: 0;"><span style="color: var(--text-secondary); font-weight: 600;">‚úì Done/Archived:</span> Tapping the üì± Posted icon automatically moves samples to your archive.</p>
                </div>
            </div>
            
            <!-- Troubleshooting -->
            <div style="margin-bottom: 10px;">
                <h3 style="color: var(--orange); margin-bottom: 12px; font-size: 1.1rem;">üîß Troubleshooting</h3>
                <div style="background: #FFF3E0; padding: 15px; border-radius: 8px; border-left: 3px solid var(--orange);">
                    
                    <p style="font-weight: 600; margin-bottom: 8px;">TikTok Won't Open:</p>
                    <p style="font-size: 0.9rem; margin-bottom: 12px; color: #666;">‚Ä¢ Make sure TikTok app is installed<br>‚Ä¢ Try tapping "Ready to Film" again<br>‚Ä¢ If still not working, manually open TikTok camera</p>
                    
                    <p style="font-weight: 600; margin-bottom: 8px;">Can't Return to SampleFlow:</p>
                    <p style="font-size: 0.9rem; margin-bottom: 12px; color: #666;">‚Ä¢ Tap your phone's back button several times until you return to app<br>‚Ä¢ Or swipe up and select SampleFlow from recent apps<br>‚Ä¢ On desktop, just close the TikTok tab</p>
                    
                    <p style="font-weight: 600; margin-bottom: 8px;">Cloud Sync Not Working:</p>
                    <p style="font-size: 0.9rem; margin-bottom: 12px; color: #666;">‚Ä¢ Check you're signed in (look for cloud icon)<br>‚Ä¢ Refresh the page<br>‚Ä¢ Sign out and sign back in</p>
                    
                    <p style="font-weight: 600; margin-bottom: 8px;">Photos Won't Upload:</p>
                    <p style="font-size: 0.9rem; margin-bottom: 12px; color: #666;">‚Ä¢ Check file is under 5MB<br>‚Ä¢ Use JPG, PNG, or HEIC format<br>‚Ä¢ Try a different photo</p>
                    
                    <p style="font-weight: 600; margin-bottom: 8px;">Script Generator Not Working:</p>
                    <p style="font-size: 0.9rem; margin-bottom: 0; color: #666;">‚Ä¢ Check your daily limit (Free: 1/day, Pro: 5/day)<br>‚Ä¢ Make sure you're signed in<br>‚Ä¢ Try again in a few minutes</p>
                    
                </div>
            </div>
            
        </div>
        
        <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border); text-align: center;">
            <p style="font-size: 0.9rem; color: var(--text-secondary);">Need more help? <a href="#" onclick="openSupport(); return false;" style="color: var(--primary);">Contact Support</a></p>
        </div>
    </div>
</div>

    <div id="installModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üì≤ Install as App</h2>
                <button class="modal-close" onclick="closeInstall()">√ó</button>
            </div>
            <div style="line-height: 1.6;">
                <div style="background: #FFF8E1; padding: 15px; border-radius: 12px; border-left: 4px solid var(--yellow); margin-bottom: 20px;">
                    <p style="font-size: 0.95rem; margin-bottom: 10px; color: #444;">For the best experience, add SampleFlow to your home screen:</p>
                    <p style="margin-bottom: 10px; color: #444;"><strong>iOS (iPhone/iPad):</strong> Tap the <span style="font-size: 1.2rem;">‚éã</span> (Share) button in Safari, then scroll down and tap <strong>"Add to Home Screen"</strong>.</p>
                    <p style="color: #444;"><strong>Android:</strong> Tap the <span style="font-size: 1.2rem;">‚ãÆ</span> menu in Chrome and select <strong>"Install App"</strong> or <strong>"Add to Home Screen"</strong>.</p>
                </div>
            </div>
        </div>
    </div>

    <div id="browserOverlay" class="browser-overlay">
        <div class="browser-header">
            <button class="browser-close" onclick="closeBrowser()">√ó</button>
            <div class="browser-title">Product Link</div>
            <div style="width:40px;"></div>
        </div>
        <iframe id="browserFrame" class="browser-frame" sandbox="allow-same-origin allow-scripts allow-popups allow-forms"></iframe>
    </div>

    <div id="photoViewerModal" class="modal" onclick="closePhotoViewer()">
        <div class="modal-content" style="max-width: 90%; max-height: 90vh; padding: 0; background: transparent; box-shadow: none;" onclick="event.stopPropagation()">
            <button class="browser-close" onclick="closePhotoViewer()" style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; border-radius: 50%; width: 50px; height: 50px; font-size: 2rem; z-index: 10;">√ó</button>
            <img id="photoViewerImg" style="width: 100%; height: auto; max-height: 90vh; object-fit: contain; border-radius: 12px;">
        </div>
    </div>

    <script>

    // ==================== GLOBAL PWA INSTALL LOGIC ====================
// We attach this to 'window' to ensure the HTML button can ALWAYS see it.
window.deferredPrompt = null;

// 1. Capture the browser's install event
window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    window.deferredPrompt = e;
    console.log('‚úÖ PWA install event captured and ready');
    
    // Force show the buttons now that we know the prompt is ready
    const fBtn = document.getElementById('floatingInstallBtn');
    const mBtn = document.getElementById('installBtnMenu');
    if (fBtn) fBtn.style.display = 'block';
    if (mBtn) mBtn.style.display = 'block';
});

// 2. The Primary Install Function (FAIL-SAFE)
window.installApp = async function() {
    console.log("üëÜ Install button clicked");

    if (window.deferredPrompt) {
        console.log("üöÄ Launching native prompt...");
        window.deferredPrompt.prompt();
        const { outcome } = await window.deferredPrompt.userChoice;
        console.log(`User response: ${outcome}`);
        window.deferredPrompt = null; // Prompt can only be used once
    } else {
        console.log("‚ÑπÔ∏è Native prompt unavailable. Opening instructions.");
        // Try to call your instructions modal
        if (typeof showInstallInstructions === 'function') {
            showInstallInstructions();
        } else {
            alert('To install: Open your browser menu (‚ãÆ) and select "Install App" or "Add to Home Screen".');
        }
    }
};

// 3. Decide when to auto-show the install buttons
(function () {
    const installBtnFloating = document.getElementById('floatingInstallBtn');
    const installBtnMenu = document.getElementById('installBtnMenu');

    // Detect if already running as installed app
    const isStandalone =
        window.matchMedia('(display-mode: standalone)').matches ||
        window.navigator.standalone === true;

    // Check flags in localStorage
    const alreadyInstalled = localStorage.getItem('sampleflow_installed') === 'true';
    const dismissedAt = parseInt(localStorage.getItem('sampleflow_install_dismissed_at') || '0', 10);

    const ONE_DAY_MS = 24 * 60 * 60 * 1000;
    const canShowAgain = !dismissedAt || (Date.now() - dismissedAt) > ONE_DAY_MS;

    // Only auto-show if: not standalone, not marked installed, and not dismissed in last day
    if (!isStandalone && !alreadyInstalled && canShowAgain) {
        setTimeout(() => {
            if (installBtnFloating) installBtnFloating.style.display = 'block';
            if (installBtnMenu) installBtnMenu.style.display = 'block';
        }, 3000);
    } else {
        // Otherwise, keep them hidden
        if (installBtnFloating) installBtnFloating.style.display = 'none';
        if (installBtnMenu) installBtnMenu.style.display = 'none';
    }
})();

// 4. Manual Instructions Fallback
window.showInstallInstructions = function() {
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    
    const existing = document.getElementById('installInstructionsModal');
    if (existing) existing.remove();

    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.id = 'installInstructionsModal';
    
    // Custom logic to mention SampleFlow specifically
    let instructionsHtml = isIOS ? `
        <p style="margin-bottom: 12px; font-weight: 600;">To add SampleFlow to your iPhone:</p>
        <p style="margin-bottom: 8px;"><strong>1.</strong> Tap the <span style="font-size: 1.3rem;">‚éã</span> <strong>Share</strong> button at the bottom of Safari.</p>
        <p style="margin-bottom: 8px;"><strong>2.</strong> Scroll down and tap <strong>Add to Home Screen</strong>.</p>
        <p style="margin-bottom: 0;"><strong>3.</strong> Confirm the name "SampleFlow" and tap <strong>Add</strong>.</p>` : `
        <p style="margin-bottom: 12px; font-weight: 600;">To install SampleFlow as an app:</p>
        <p style="margin-bottom: 8px;"><strong>1.</strong> Tap the browser menu (‚ãÆ) in the top right.</p>
        <p style="margin-bottom: 8px;"><strong>2.</strong> Select <strong>Install App</strong> or <strong>Add to Home Screen</strong>.</p>`;

    modal.innerHTML = `
        <div class="modal-content" style="max-width: 400px; text-align: center;">
            <div style="font-size: 3rem; margin-bottom: 15px;">üì≤</div>
            <h2 class="modal-title" style="margin-bottom: 10px;">Get the App</h2>
            <div style="text-align: left; font-size: 0.95rem; color: var(--text-main); margin-bottom: 20px; line-height: 1.6; background: var(--bg); padding: 15px; border-radius: 12px;">
                ${instructionsHtml}
            </div>
            <button class="row-btn btn-full-width" onclick="document.getElementById('installInstructionsModal').remove()">Got it</button>
        </div>`;
    document.body.appendChild(modal);
};

// 5. Hide install buttons when app is installed
window.addEventListener('appinstalled', () => {
    console.log('‚úÖ App installed successfully!');
    const installBtnFloating = document.getElementById('floatingInstallBtn');
    const installBtnMenu = document.getElementById('installBtnMenu');
    if (installBtnFloating) installBtnFloating.style.display = 'none';
    if (installBtnMenu) installBtnMenu.style.display = 'none';

    // Remember that the app is installed on this device
    localStorage.setItem('sampleflow_installed', 'true');
});

// 6. Dismiss Install button
function dismissInstallButton() {
    const installBtnFloating = document.getElementById('floatingInstallBtn');
    if (installBtnFloating) installBtnFloating.style.display = 'none';

    // Remember when the user dismissed it
    localStorage.setItem('sampleflow_install_dismissed_at', Date.now().toString());
}
       

// 5. Final Service Worker Registration
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js')
            .then(reg => console.log('‚úÖ SW Registered'))
            .catch(err => console.error('‚ùå SW Failed', err));
    });
}
        // ==================== UPGRADE MODAL ====================
        function showUpgradeModal(title, message, targetTier) {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'upgradeModal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <h2 class="modal-title">‚ú® Upgrade Your Plan</h2>
                        <button class="modal-close" onclick="closeUpgradeModal()">√ó</button>
                    </div>
                    
                    <div style="text-align: center; margin-bottom: 25px;">
                        <div style="font-size: 2.5rem; margin-bottom: 10px;">üöÄ</div>
                        <h3 style="font-weight: 700; font-size: 1.2rem; margin-bottom: 10px; color: var(--text-main);">${title}</h3>
                        <p style="color: var(--text-secondary);">${message}</p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <!-- BASIC PLAN -->
                        <div style="background: ${targetTier === 'basic' ? 'linear-gradient(135deg, #E8F5E9, #C8E6C9)' : 'var(--bg)'}; border: ${targetTier === 'basic' ? '3px solid #00C853' : '2px solid var(--border)'}; border-radius: 12px; padding: 20px; position: relative;">
                            ${targetTier === 'basic' ? '<div style="position: absolute; top: -12px; left: 50%; transform: translateX(-50%); background: #00C853; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.75rem; font-weight: 800;">RECOMMENDED</div>' : ''}
                            
                            <div style="text-align: center; margin-bottom: 15px;">
                                <h4 style="font-size: 1.3rem; font-weight: 800; margin-bottom: 5px;">üíé Basic</h4>
                                <div style="font-size: 2rem; font-weight: 800; color: var(--primary);">$9.95</div>
                                <div style="font-size: 0.8rem; color: var(--text-secondary);">per month</div>
                            </div>
                            
                            <div style="text-align: left; font-size: 0.85rem; margin-bottom: 15px;">
                                <div style="margin-bottom: 6px;">‚úì Unlimited samples</div>
                                <div style="margin-bottom: 6px;">‚úì Calendar view</div>
                                <div style="margin-bottom: 6px;">‚úì 2 photos per sample</div>
                                <div style="margin-bottom: 6px;">‚úì Batch actions</div>
                                <div style="margin-bottom: 6px;">‚úì Custom reminders</div>
                                <div style="margin-bottom: 6px;">‚úì 1 AI script/day</div>
                            </div>
                            
                            <button class="row-btn btn-full-width" onclick="startUpgrade('basic')" style="background: ${targetTier === 'basic' ? 'linear-gradient(135deg, #00C853, #00E676)' : 'var(--primary)'}; color: white; font-weight: 700;">
                                Choose Basic
                            </button>
                        </div>
                        
                        <!-- PRO PLAN -->
                        <div style="background: ${targetTier === 'pro' ? 'linear-gradient(135deg, #FFF8E1, #FFECB3)' : 'var(--bg)'}; border: ${targetTier === 'pro' ? '3px solid #FFB300' : '2px solid var(--border)'}; border-radius: 12px; padding: 20px; position: relative;">
                            ${targetTier === 'pro' ? '<div style="position: absolute; top: -12px; left: 50%; transform: translateX(-50%); background: #FFB300; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.75rem; font-weight: 800;">RECOMMENDED</div>' : ''}
                            
                            <div style="text-align: center; margin-bottom: 15px;">
                                <h4 style="font-size: 1.3rem; font-weight: 800; margin-bottom: 5px;">üëë Pro</h4>
                                <div style="font-size: 2rem; font-weight: 800; color: var(--primary);">$14.95</div>
                                <div style="font-size: 0.8rem; color: var(--text-secondary);">per month</div>
                            </div>
                            
                            <div style="text-align: left; font-size: 0.85rem; margin-bottom: 15px;">
                                <div style="margin-bottom: 6px; font-weight: 700;">Everything in Basic, plus:</div>
                                <div style="margin-bottom: 6px;">‚úì Analytics dashboard</div>
                                <div style="margin-bottom: 6px;">‚úì Export to CSV</div>
                                <div style="margin-bottom: 6px;">‚úì Import data</div>
                                <div style="margin-bottom: 6px;">‚úì Ready-to-Film button</div>
                                <div style="margin-bottom: 6px;">‚úì 3 photos per sample</div>
                                <div style="margin-bottom: 6px;">‚úì 5 AI scripts/day</div>
                            </div>
                            
                            <button class="row-btn btn-full-width" onclick="startUpgrade('pro')" style="background: ${targetTier === 'pro' ? 'linear-gradient(135deg, #FFB300, #FFC107)' : 'var(--primary)'}; color: white; font-weight: 700;">
                                Choose Pro
                            </button>
                        </div>
                    </div>
                    
                    <button class="row-btn btn-secondary btn-full-width" onclick="closeUpgradeModal()" style="margin-top: 10px;">
                        Maybe Later
                    </button>
                    
                    <p style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 15px; text-align: center;">
                        ‚úì Cancel anytime ‚Ä¢ ‚úì 14-day money-back guarantee
                    </p>
                </div>
            `;
            document.body.appendChild(modal);
        }      
                
        function closeUpgradeModal() {
            const modal = document.getElementById('upgradeModal');
            if (modal) modal.remove();
        }
        
        function startUpgrade(tier) {
            const checkoutUrls = {
                basic: 'https://lazybstudios.lemonsqueezy.com/checkout/buy/a921ce0f-6637-4263-a5d7-2cf1f648b9bf?checkout[custom][return_url]=https://sampleflow.lazybstudios.com',
                pro: 'https://lazybstudios.lemonsqueezy.com/checkout/buy/d324fe3e-0a61-4d6c-bffd-25e7a92d1ef0?checkout[custom][return_url]=https://sampleflow.lazybstudios.com'
            };
        
            // Add user email to checkout if signed in
            let url = checkoutUrls[tier];
            if (currentUser && currentUser.email) {
                url += `?checkout[email]=${encodeURIComponent(currentUser.email)}&checkout[custom][user_id]=${currentUser.id}`;
            }
        
            // Redirect to checkout
            window.location.href = url;
        }
       
        // ==================== CHANGE PASSWORD ====================
        function openChangePassword() {
            if (!useCloud || !currentUser) {
                alert('You must be signed in to change your password');
                return;
            }
            document.getElementById('changePasswordModal').classList.add('active');
        }

        function closeChangePassword() {
            document.getElementById('changePasswordModal').classList.remove('active');
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmNewPassword').value = '';
            document.getElementById('changePasswordError').style.display = 'none';
        }

        async function handleChangePassword() {
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmNewPassword').value;
    const errorDiv = document.getElementById('changePasswordError');
    
    if (!newPassword || newPassword.length < 6) {
        errorDiv.textContent = 'Password must be at least 6 characters';
        errorDiv.style.display = 'block';
        return;
    }
    
    if (newPassword !== confirmPassword) {
        errorDiv.textContent = 'Passwords do not match';
        errorDiv.style.display = 'block';
        return;
    }
    
    try {
        const { error } = await sb_client.auth.updateUser({
            password: newPassword
        });
        
        if (error) throw error;
        
        alert('Password updated successfully!');
        closeChangePassword();
    } catch (e) {
        errorDiv.textContent = 'Failed to update password: ' + e.message;
        errorDiv.style.display = 'block';
    }
}

        // ==================== CHANGE EMAIL ====================
        function openChangeEmail() {
            if (!useCloud || !currentUser) {
                alert('You must be signed in to change your email');
                return;
            }
            const currentEmail = localStorage.getItem('user_email') || currentUser.email || 'Unknown';
            document.getElementById('currentEmailDisplay').value = currentEmail;
            document.getElementById('newEmail').value = '';
            document.getElementById('emailChangePassword').value = '';
            document.getElementById('changeEmailError').style.display = 'none';
            document.getElementById('changeEmailModal').classList.add('active');
        }

        function closeChangeEmail() {
            document.getElementById('changeEmailModal').classList.remove('active');
        }

        async function handleChangeEmail() {
            const newEmail = document.getElementById('newEmail').value.trim();
            const password = document.getElementById('emailChangePassword').value;
            const errorDiv = document.getElementById('changeEmailError');
            
            if (!newEmail) {
                errorDiv.textContent = 'Please enter a new email address';
                errorDiv.style.display = 'block';
                return;
            }
            
            if (!password) {
                errorDiv.textContent = 'Please enter your password to confirm';
                errorDiv.style.display = 'block';
                return;
            }
            
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(newEmail)) {
                errorDiv.textContent = 'Please enter a valid email address';
                errorDiv.style.display = 'block';
                return;
            }
            
            try {
                const currentEmail = localStorage.getItem('user_email') || currentUser.email;
                const { error: signInError } = await sb_client.auth.signInWithPassword({
                    email: currentEmail,
                    password: password
                });
                
                if (signInError) {
                    errorDiv.textContent = 'Incorrect password';
                    errorDiv.style.display = 'block';
                    return;
                }
                
                const { error } = await sb_client.auth.updateUser({
                    email: newEmail
                });
                
                if (error) throw error;
                
                localStorage.setItem('user_email', newEmail);
                if (currentUser) currentUser.email = newEmail;
                
                alert('Email change initiated! Please check your new email for a verification link.');
                closeChangeEmail();
                updateCloudStatus();
                updateSettingsAccountInfo();
                
            } catch (e) {
                errorDiv.textContent = 'Failed to change email: ' + e.message;
                errorDiv.style.display = 'block';
            }
        }

        // ==================== DELETE ACCOUNT ====================
        function openDeleteAccountModal() {
            if (!useCloud || !currentUser) {
                alert('You must be signed in to delete your account');
                return;
            }
            document.getElementById('deleteConfirmInput').value = '';
            document.getElementById('deleteAccountError').style.display = 'none';
            document.getElementById('deleteAccountModal').classList.add('active');
        }

        function closeDeleteAccountModal() {
            document.getElementById('deleteAccountModal').classList.remove('active');
        }

async function confirmDeleteAccount() {
    const confirmText = document.getElementById('deleteConfirmInput').value.trim().toUpperCase();
    const errorDiv = document.getElementById('deleteAccountError');
    
    if (confirmText !== 'DELETE') {
        errorDiv.textContent = 'Please type DELETE to confirm';
        errorDiv.style.display = 'block';
        return;
    }
    
    if (!confirm('Are you absolutely sure? This will permanently delete your account and all data. This action cannot be undone.')) {
        return;
    }
    
    try {
        errorDiv.textContent = 'Deleting your account...';
        errorDiv.style.color = 'var(--text-secondary)';
        errorDiv.style.display = 'block';
        
        // Get the current session token
        const { data: { session }, error: sessionError } = await sb_client.auth.getSession();
        
        if (sessionError || !session) {
            throw new Error('You must be signed in to delete your account');
        }
        
        // Call the Edge Function to delete the account completely
        const response = await fetch('https://eiigbmrjtwndanywrcqp.supabase.co/functions/v1/delete-account', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${session.access_token}`,
                'apikey': SUPABASE_ANON_KEY
            }
        });
        
        const result = await response.json();
        
        if (!response.ok) {
            throw new Error(result.error || 'Failed to delete account');
        }
        
        // Clear all local data
        localStorage.clear();
        
        // Reset app state
        currentUser = null;
        useCloud = false;
        samples = [];
        settings = { defaultDays: 14 };
        
        closeDeleteAccountModal();
        
        // Show success message
        const successModal = document.createElement('div');
        successModal.className = 'modal active';
        successModal.innerHTML = `
            <div class="modal-content" style="max-width: 400px;">
                <div class="modal-header">
                    <h2 class="modal-title" style="color: var(--green);">‚úì Account Deleted</h2>
                </div>
                <div style="text-align: center; padding: 20px;">
                    <div style="font-size: 4rem; margin-bottom: 20px;">‚úÖ</div>
                    <p style="font-size: 1.1rem; font-weight: 600; margin-bottom: 15px;">Your account has been completely deleted</p>
                    <p style="margin-bottom: 20px; color: var(--text-secondary);">All your data and login credentials have been permanently removed.</p>
                    <button class="row-btn btn-full-width" onclick="window.location.reload()">Return to Home</button>
                </div>
            </div>
        `;
        document.body.appendChild(successModal);
        
    } catch (e) {
        console.error('Delete account error:', e);
        errorDiv.textContent = 'Error: ' + e.message;
        errorDiv.style.color = 'var(--red)';
        errorDiv.style.display = 'block';
    }
}

   function readyToFilm(id) {
    if (userTier !== 'pro') {
        showUpgradeModal(
            'Ready-to-Film is a Pro feature!',
            'One-tap access to TikTok camera saves you time on every video',
            'pro'
        );
        return;
    }
    
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    const returnInstructions = isIOS 
        ? 'Swipe up from bottom ‚Üí Tap SampleFlow'
        : 'Tap ‚óªÔ∏è (recent apps) ‚Üí Tap SampleFlow';
    
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.id = 'tiktokLaunchModal';
    modal.innerHTML = `
        <div class="modal-content" style="text-align: center;">
            <div style="font-size: 3rem; margin-bottom: 15px;">üé¨</div>
            <h2 style="margin-bottom: 15px;">Ready to Film!</h2>
            <p style="color: var(--text-secondary); margin-bottom: 20px;">TikTok will open. When done filming:</p>
            
            <div style="background: #E8F5E9; padding: 15px; border-radius: 8px; margin-bottom: 12px; text-align: left; border-left: 4px solid var(--green);">
                <p style="font-size: 0.95rem; font-weight: 700; margin-bottom: 5px;">‚úÖ Fastest Way Back:</p>
                <p style="font-size: 0.85rem; color: #333; margin: 0;">${returnInstructions}</p>
            </div>
            
            <div style="background: var(--bg); padding: 12px; border-radius: 8px; margin-bottom: 20px; text-align: left;">
                <p style="font-size: 0.8rem; color: var(--text-secondary); margin: 0;">Or tap back button multiple times</p>
            </div>
            
            <button onclick="launchTikTokNow()" style="
                width: 100%;
                padding: 18px;
                font-size: 1.1rem;
                background: linear-gradient(135deg, #ff0050 0%, #00f2ea 100%);
                color: white;
                border: none;
                border-radius: 12px;
                font-weight: bold;
                cursor: pointer;
                margin-bottom: 12px;
            ">
                üé• Open TikTok
            </button>
            
            <button onclick="closeTikTokLaunchModal()" class="row-btn btn-secondary" style="width: 100%;">
                Cancel
            </button>
        </div>
    `;
    document.body.appendChild(modal);
}
function launchTikTokNow() {
    closeTikTokLaunchModal();
    
    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    
    if (isMobile) {
        // Direct navigation
        window.location.href = 'tiktok://camera';
        
        // Fallback to web if app not installed
        setTimeout(() => {
            if (document.hasFocus()) {
                window.location.href = 'https://www.tiktok.com/upload';
            }
        }, 1500);
    } else {
        // Desktop - open in new tab
        window.open('https://www.tiktok.com/creator-tools/upload', '_blank');
    }
}

function closeTikTokLaunchModal() {
    const modal = document.getElementById('tiktokLaunchModal');
    if (modal) modal.remove();
}

        function showToast(message, duration = 3000) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                bottom: 80px;
                left: 50%;
                transform: translateX(-50%);
                background: var(--surface);
                color: var(--text-main);
                padding: 12px 24px;
                border-radius: 24px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 10000;
                font-size: 0.9rem;
                font-weight: 600;
                border: 1px solid var(--border);
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transition = 'opacity 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }
            // ==================== IN-APP NOTIFICATIONS ====================
function checkDueNotifications() {
    // Check if banner notifications are enabled
    const enabled = localStorage.getItem('banner_notifications_enabled') !== 'false';
    if (!enabled) return;
    
    // Don't show if not logged in or no samples
    if (!currentUser || samples.length === 0) return;
    
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const todayStr = today.toISOString().split('T')[0];
    
    // Check if already dismissed today
    const dismissedDate = localStorage.getItem('notification_dismissed_date');
    if (dismissedDate === todayStr) return;
    
    // Count items by days until due
    let overdueCount = 0;
    let dueTodayCount = 0;
    let due1DayCount = 0;
    let due2DayCount = 0;
    let due3DayCount = 0;
    
    samples.filter(s => !s.done).forEach(s => {
        const dueDate = new Date(new Date(s.date).getTime() + s.limit * 86400000);
        dueDate.setHours(0, 0, 0, 0);
        
        const daysUntilDue = Math.floor((dueDate - today) / 86400000);
        
        if (daysUntilDue < 0) {
            overdueCount++;
        } else if (daysUntilDue === 0) {
            dueTodayCount++;
        } else if (daysUntilDue === 1) {
            due1DayCount++;
        } else if (daysUntilDue === 2) {
            due2DayCount++;
        } else if (daysUntilDue === 3) {
            due3DayCount++;
        }
    });
    
    const banner = document.getElementById('notificationBanner');
    const icon = document.getElementById('bannerIcon');
    const title = document.getElementById('bannerTitle');
    const subtitle = document.getElementById('bannerSubtitle');
    const details = document.getElementById('bannerDetails');
    
    // Remove previous state classes
    banner.classList.remove('urgent', 'good', 'flash');
    
    // Build details string
    let detailParts = [];
    if (overdueCount > 0) detailParts.push(`üî• ${overdueCount} overdue`);
    if (dueTodayCount > 0) detailParts.push(`‚è∞ ${dueTodayCount} today`);
    if (due1DayCount > 0) detailParts.push(`üìÖ ${due1DayCount} tomorrow`);
    if (due2DayCount > 0) detailParts.push(`üìã ${due2DayCount} in 2 days`);
    if (due3DayCount > 0) detailParts.push(`üìã ${due3DayCount} in 3 days`);
    
    // Nothing to show
    if (detailParts.length === 0) {
        banner.classList.remove('active');
        return;
    }
    
    details.textContent = detailParts.join('  ‚Ä¢  ');
    
    // Determine banner style based on urgency
    if (overdueCount > 0) {
        // Critical - Overdue (red, flashing)
        icon.textContent = 'üî•';
        title.textContent = `${overdueCount} Overdue Sample${overdueCount > 1 ? 's' : ''}!`;
        subtitle.textContent = 'These need your attention NOW';
        banner.classList.add('active', 'flash');
        
    } else if (dueTodayCount > 0) {
        // Urgent - Due today (yellow, flashing)
        icon.textContent = '‚è∞';
        title.textContent = `${dueTodayCount} Sample${dueTodayCount > 1 ? 's' : ''} Due Today!`;
        subtitle.textContent = 'Post these before the day ends';
        banner.classList.add('urgent', 'active', 'flash');
        
    } else if (due1DayCount > 0) {
        // Tomorrow (yellow, no flash)
        icon.textContent = 'üìÖ';
        title.textContent = `${due1DayCount} Sample${due1DayCount > 1 ? 's' : ''} Due Tomorrow`;
        subtitle.textContent = 'Get ready for these';
        banner.classList.add('urgent', 'active');
        
    } else {
        // 2-3 days out (green, no flash)
        const upcomingCount = due2DayCount + due3DayCount;
        icon.textContent = 'üìã';
        title.textContent = `${upcomingCount} Sample${upcomingCount > 1 ? 's' : ''} Coming Up`;
        subtitle.textContent = 'Due in the next few days';
        banner.classList.add('good', 'active');
    }
}
function dismissNotificationBanner() {
    const banner = document.getElementById('notificationBanner');
    banner.style.animation = 'none';
    banner.style.transform = 'translateY(-100%)';
    banner.style.opacity = '0';
    banner.style.transition = 'all 0.3s ease';
    
    setTimeout(() => {
        banner.classList.remove('active');
        banner.style.transform = '';
        banner.style.opacity = '';
        banner.style.transition = '';
        banner.style.animation = '';
    }, 300);
    
    // Remember dismissal for today
    const today = new Date().toISOString().split('T')[0];
    localStorage.setItem('notification_dismissed_date', today);
}

function scrollToFilter(filterType) {
    // Dismiss the banner
    dismissNotificationBanner();
    
    // Apply the filter
    setFilter(filterType === 'overdue' ? 'overdue' : 'urgent');
    
    // Scroll to the sample grid
    setTimeout(() => {
        document.getElementById('sampleGrid').scrollIntoView({ behavior: 'smooth' });
    }, 100);
}

// Function to manually trigger notification check (can be called from settings)
function refreshNotifications() {
    // Clear today's dismissal to show again
    localStorage.removeItem('notification_dismissed_date');
    checkDueNotifications();
}

// ==================== BANNER NOTIFICATION TOGGLE ====================
function toggleBannerNotifications(enabled) {
    triggerHaptic();
    localStorage.setItem('banner_notifications_enabled', enabled ? 'true' : 'false');
    
    if (enabled) {
        localStorage.removeItem('notification_dismissed_date');
        checkDueNotifications();
        showToast('Reminders enabled');
    } else {
        const banner = document.getElementById('notificationBanner');
        if (banner) banner.classList.remove('active');
        showToast('Reminders disabled');
    }
}

function loadBannerNotificationSetting() {
    const enabled = localStorage.getItem('banner_notifications_enabled') !== 'false';
    const toggle = document.getElementById('bannerNotificationsToggle');
    if (toggle) toggle.checked = enabled;
    return enabled;
}
    </script>
    
    <script>

// ==================== BETA FEEDBACK ====================
const BETA_TEST_SECTIONS = [
    {
        id: "account",
        title: "1. Account & Authentication",
        items: [
            { id: "account_create", label: "Create new account" },
            { id: "account_signin", label: "Sign in with existing account" },
            { id: "account_signout", label: "Sign out successfully" },
            { id: "account_remember", label: "'Keep me logged in' works" },
            { id: "account_autosign", label: "Auto sign-in on return visit" },
            { id: "account_change_email", label: "Change email address" },
            { id: "account_change_password", label: "Change password" },
            { id: "account_delete", label: "Delete account completely" },
            { id: "account_cloud_sync", label: "Cloud sync across devices" },
        ]
    },
    {
        id: "samples",
        title: "2. Sample Management",
        items: [
            { id: "sample_add", label: "Add new sample" },
            { id: "sample_edit", label: "Edit existing sample" },
            { id: "sample_delete", label: "Delete sample" },
            { id: "sample_cancel", label: "Cancel button discards changes" },
            { id: "sample_mark_posted", label: "Mark as Posted (via checklist)" },
            { id: "sample_auto_archive", label: "Posted samples auto-archive" },
            { id: "sample_search_brand", label: "Search by brand name" },
            { id: "sample_search_product", label: "Search by product name" },
            { id: "sample_batch_select", label: "Batch select samples" },
            { id: "sample_batch_done", label: "Batch archive selected" },
            { id: "sample_batch_delete", label: "Batch delete" },
        ]
    },
    {
        id: "fields",
        title: "3. Sample Fields",
        items: [
            { id: "field_product", label: "Product name saves" },
            { id: "field_brand", label: "Brand name saves" },
            { id: "field_date", label: "Date picker works" },
            { id: "field_days", label: "Days to post works" },
            { id: "field_due_preview", label: "Due date calculates correctly" },
            { id: "field_link", label: "Product link saves" },
            { id: "field_tags_add", label: "Add tags (Enter key)" },
            { id: "field_tags_remove", label: "Remove tags" },
            { id: "field_notes", label: "Notes save" },
            { id: "field_photo_upload", label: "Upload photos" },
            { id: "field_photo_remove", label: "Remove photos" },
            { id: "field_photo_view", label: "View photo fullscreen" },
            { id: "field_checklist_filmed", label: "Filmed checkbox works" },
            { id: "field_checklist_edited", label: "Edited checkbox works" },
            { id: "field_checklist_posted", label: "Posted checkbox works" },
        ]
    },
    {
        id: "filters",
        title: "4. Filters & Sorting",
        items: [
            { id: "filter_all", label: "Filter: All" },
            { id: "filter_overdue", label: "Filter: Overdue" },
            { id: "filter_urgent", label: "Filter: Due Soon" },
            { id: "filter_good", label: "Filter: On Track" },
            { id: "filter_completed", label: "Filter: Posted" },
            { id: "filter_counts", label: "Filter counts update correctly" },
            { id: "sort_due", label: "Sort by Due Date" },
            { id: "sort_brand", label: "Sort by Brand" },
            { id: "sort_received", label: "Sort by Received" },
        ]
    },
   {
    id: "views",
    title: "5. Views & Display",
    items: [
        { id: "view_list", label: "List view works" },
        { id: "view_calendar", label: "Calendar view works (Basic+)" },
        { id: "view_calendar_nav", label: "Calendar month navigation" },
        { id: "view_calendar_details", label: "Calendar day details popup" },
        { id: "view_full", label: "Full view button works" },
        { id: "view_compact_btn", label: "Compact view button works" },
        { id: "view_card_tap", label: "Tap card to expand in Compact view" },
        { id: "view_dark_mode", label: "Dark mode displays correctly" },
        { id: "view_compact_setting", label: "Compact mode in Settings" },
        { id: "view_progress_bar", label: "Progress bar accurate" },
        { id: "view_status_badges", label: "Status badges show correctly" },
    ]
},
    {
        id: "notifications",
        title: "6. In-App Notifications",
        items: [
            { id: "notif_banner_shows", label: "Banner shows on app open" },
            { id: "notif_overdue_red", label: "Overdue shows red banner" },
            { id: "notif_today_yellow", label: "Due today shows yellow banner" },
            { id: "notif_tomorrow", label: "Due tomorrow shows in banner" },
            { id: "notif_details", label: "Banner shows breakdown (overdue, today, tomorrow, etc.)" },
            { id: "notif_flash", label: "Banner flashes for overdue/due today" },
            { id: "notif_dismiss", label: "Dismiss banner (X button)" },
            { id: "notif_stays_dismissed", label: "Banner stays dismissed for the day" },
            { id: "notif_view_button", label: "View button filters to relevant samples" },
            { id: "notif_toggle_off", label: "Settings toggle disables banner" },
            { id: "notif_toggle_on", label: "Settings toggle enables banner" },
        ]
    },
    {
        id: "tiers",
        title: "7. Subscription & Tiers",
        items: [
            { id: "tier_free_limit", label: "Free: 5 sample limit enforced" },
            { id: "tier_free_photo", label: "Free: 1 photo limit enforced" },
            { id: "tier_upgrade_modal", label: "Upgrade modal appears" },
            { id: "tier_basic_unlock", label: "Basic features unlock" },
            { id: "tier_pro_unlock", label: "Pro features unlock" },
            { id: "tier_manage_sub", label: "Manage Subscription button" },
        ]
    },
    {
        id: "pro",
        title: "8. Pro Features",
        items: [
            { id: "pro_film", label: "Ready to Film button" },
            { id: "pro_film_tiktok", label: "TikTok opens from Ready to Film" },
            { id: "pro_script", label: "AI Script Generator works" },
            { id: "pro_script_copy", label: "Copy script to clipboard" },
            { id: "pro_script_regenerate", label: "Generate new script" },
            { id: "pro_analytics", label: "Analytics dashboard" },
            { id: "pro_export", label: "Export to CSV" },
            { id: "pro_import", label: "Import data (JSON)" },
        ]
    },
    {
        id: "settings",
        title: "9. Settings",
        items: [
            { id: "setting_dark_toggle", label: "Dark mode toggle" },
            { id: "setting_dark_persist", label: "Dark mode persists on reload" },
            { id: "setting_haptic", label: "Haptic feedback toggle" },
            { id: "setting_compact", label: "Compact mode toggle" },
            { id: "setting_banner_notif", label: "Due date reminders toggle" },
            { id: "setting_default_days", label: "Default days to post" },
            { id: "setting_clear_completed", label: "Clear completed samples" },
            { id: "setting_reset", label: "Reset app data" },
            { id: "setting_account_info", label: "Account info displays" },
        ]
    },
    {
        id: "pwa",
        title: "10. PWA & Installation",
        items: [
            { id: "pwa_floating_btn", label: "Floating install button appears" },
            { id: "pwa_menu_btn", label: "Menu install button appears" },
            { id: "pwa_install_prompt", label: "Install prompt works" },
            { id: "pwa_dismiss", label: "Dismiss install button (X)" },
            { id: "pwa_instructions", label: "Manual install instructions" },
            { id: "pwa_hidden_standalone", label: "Install hidden when installed" },
        ]
    },
    {
        id: "ui",
        title: "11. General UI",
        items: [
            { id: "ui_landing", label: "Landing page displays" },
            { id: "ui_modals_open", label: "Modals open correctly" },
            { id: "ui_modals_close", label: "Modals close (X and outside)" },
            { id: "ui_menu", label: "Menu opens/closes" },
            { id: "ui_help", label: "Help modal content" },
            { id: "ui_support", label: "Contact support link" },
            { id: "ui_privacy", label: "Privacy Policy opens" },
            { id: "ui_terms", label: "Terms of Service opens" },
            { id: "ui_photo_viewer", label: "Photo viewer modal" },
            { id: "ui_product_link", label: "Product link browser" },
            { id: "ui_toast", label: "Toast notifications appear" },
            { id: "ui_no_errors", label: "No console errors" },
        ]
    },
];

        let betaFeedbackId = null;
let openBetaSections = new Set();  // Add this line

let betaFeedbackData = {
    test_results: {},
    bugs: [],
    suggestions: [],
    overall_rating: null,
    would_recommend: null,
    additional_comments: ''
};


async function openBetaFeedback() {
    if (!useCloud || !currentUser) {
        alert('Please sign in to submit beta feedback');
        return;
    }
    await loadBetaFeedback();
    renderBetaFeedbackContent();
    document.getElementById('betaFeedbackModal').classList.add('active');
}

function closeBetaFeedback() {
    document.getElementById('betaFeedbackModal').classList.remove('active');
}

async function loadBetaFeedback() {
    try {
        const { data, error } = await sb_client
            .from('beta_feedback')
            .select('*')
            .eq('user_id', currentUser.id)
            .single();
        
        if (data) {
            betaFeedbackId = data.id;
            betaFeedbackData = {
                test_results: data.test_results || {},
                bugs: data.bugs || [],
                suggestions: data.suggestions || [],
                overall_rating: data.overall_rating,
                would_recommend: data.would_recommend,
                additional_comments: data.additional_comments || ''
            };
        }
    } catch (e) {
        console.log('No existing beta feedback found');
    }
}

function renderBetaFeedbackContent() {
    const container = document.getElementById('betaFeedbackContent');
    const totalTests = BETA_TEST_SECTIONS.reduce((sum, s) => sum + s.items.length, 0);
    const completedTests = Object.keys(betaFeedbackData.test_results).length;
    const progressPercent = Math.round((completedTests / totalTests) * 100);
    
    let html = `
        <div style="background: var(--bg); padding: 12px; border-radius: 10px; margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <span style="font-weight: 600;">Testing Progress</span>
                <span style="font-weight: 700; color: var(--primary);">${completedTests}/${totalTests} (${progressPercent}%)</span>
            </div>
            <div style="height: 8px; background: var(--border); border-radius: 4px; overflow: hidden;">
                <div style="height: 100%; width: ${progressPercent}%; background: var(--primary); transition: width 0.3s;"></div>
            </div>
        </div>
    `;
    
    BETA_TEST_SECTIONS.forEach(section => {
        const sectionCompleted = section.items.filter(item => betaFeedbackData.test_results[item.id]).length;
        html += `
            <div class="collapsible-section">
                <div class="collapsible-header" onclick="toggleBetaSection('${section.id}')">
                    <span>${section.title}</span>
                    <span style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 0.8rem; color: var(--text-secondary);">${sectionCompleted}/${section.items.length}</span>
                        <span id="beta-arrow-${section.id}">${openBetaSections.has(section.id) ? '‚ñ≤' : '‚ñº'}</span>
                    </span>
                </div>
                <div class="collapsible-content ${openBetaSections.has(section.id) ? 'active' : ''}" id="beta-section-${section.id}">
                    <div style="padding: 10px 0;">
        `;
        section.items.forEach(item => {
            const result = betaFeedbackData.test_results[item.id] || null;
            html += `
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px; border-bottom: 1px solid var(--border);">
                    <span style="font-size: 0.9rem; flex: 1;">${item.label}</span>
                    <div style="display: flex; gap: 6px;">
                        <button onclick="setBetaResult('${item.id}', 'pass')" style="padding: 6px 10px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; background: ${result === 'pass' ? 'var(--green)' : 'var(--bg)'}; color: ${result === 'pass' ? 'white' : 'var(--text-secondary)'};">‚úì</button>
                        <button onclick="setBetaResult('${item.id}', 'fail')" style="padding: 6px 10px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; background: ${result === 'fail' ? 'var(--red)' : 'var(--bg)'}; color: ${result === 'fail' ? 'white' : 'var(--text-secondary)'};">‚úó</button>
                        <button onclick="setBetaResult('${item.id}', 'na')" style="padding: 6px 10px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; background: ${result === 'na' ? 'var(--yellow)' : 'var(--bg)'}; color: ${result === 'na' ? 'white' : 'var(--text-secondary)'};">N/A</button>
                    </div>
                </div>
            `;
        });
        html += `</div></div></div>`;
    });
    
    html += `
        <div style="margin-top: 25px;">
            <h3 style="font-weight: 700; margin-bottom: 12px; color: var(--red);">üêõ Bug Reports</h3>
            <div id="bugsList">${renderBugsList()}</div>
            <button onclick="addBug()" class="row-btn btn-secondary" style="margin-top: 10px;">+ Add Bug Report</button>
        </div>
        <div style="margin-top: 25px;">
            <h3 style="font-weight: 700; margin-bottom: 12px; color: var(--green);">üí° Suggestions</h3>
            <div id="suggestionsList">${renderSuggestionsList()}</div>
            <button onclick="addSuggestion()" class="row-btn btn-secondary" style="margin-top: 10px;">+ Add Suggestion</button>
        </div>
        <div style="margin-top: 25px; padding: 20px; background: var(--bg); border-radius: 12px;">
            <h3 style="font-weight: 700; margin-bottom: 15px;">Overall Experience</h3>
            <div style="margin-bottom: 15px;">
                <label style="font-weight: 600; display: block; margin-bottom: 8px;">Rating (1-5 stars)</label>
                <div style="display: flex; gap: 10px;">
                    ${[1,2,3,4,5].map(n => `<button onclick="setBetaRating(${n})" style="width: 45px; height: 45px; border-radius: 50%; border: 2px solid var(--border); background: ${betaFeedbackData.overall_rating === n ? 'var(--primary)' : 'var(--surface)'}; color: ${betaFeedbackData.overall_rating === n ? 'white' : 'var(--text-main)'}; font-weight: 700; font-size: 1.1rem; cursor: pointer;">${n}</button>`).join('')}
                </div>
            </div>
            <div style="margin-bottom: 15px;">
                <label style="font-weight: 600; display: block; margin-bottom: 8px;">Would you recommend SampleFlow?</label>
                <div style="display: flex; gap: 10px;">
                    ${['Yes', 'No', 'Maybe'].map(opt => `<button onclick="setBetaRecommend('${opt}')" style="padding: 10px 20px; border-radius: 10px; border: 2px solid var(--border); background: ${betaFeedbackData.would_recommend === opt ? 'var(--primary)' : 'var(--surface)'}; color: ${betaFeedbackData.would_recommend === opt ? 'white' : 'var(--text-main)'}; font-weight: 600; cursor: pointer;">${opt}</button>`).join('')}
                </div>
            </div>
            <div>
                <label style="font-weight: 600; display: block; margin-bottom: 8px;">Additional Comments</label>
                <textarea id="betaComments" class="form-textarea" style="min-height: 100px;" onchange="setBetaComments(this.value)" placeholder="Any other thoughts or feedback...">${betaFeedbackData.additional_comments}</textarea>
            </div>
        </div>
        <div style="margin-top: 20px;">
            <button onclick="submitBetaFeedback()" class="row-btn btn-full-width" style="background: var(--green);">‚úì Save Feedback</button>
            <p style="font-size: 0.8rem; color: var(--text-secondary); text-align: center; margin-top: 10px;">Your progress is saved automatically as you test</p>
        </div>
    `;
    container.innerHTML = html;
}

function renderBugsList() {
    if (betaFeedbackData.bugs.length === 0) return '<p style="color: var(--text-secondary); font-size: 0.9rem;">No bugs reported yet</p>';
    return betaFeedbackData.bugs.map((bug, i) => `
        <div style="background: var(--surface); border: 1px solid var(--border); border-left: 3px solid var(--red); padding: 12px; border-radius: 8px; margin-bottom: 10px;">
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <div style="flex: 1;"><p style="font-weight: 600; margin-bottom: 5px;">${bug.description || 'No description'}</p><p style="font-size: 0.8rem; color: var(--text-secondary);">Severity: ${bug.severity || 'Not set'}</p></div>
                <button onclick="removeBug(${i})" style="background: none; border: none; color: var(--red); cursor: pointer; font-size: 1.2rem;">√ó</button>
            </div>
        </div>
    `).join('');
}

function renderSuggestionsList() {
    if (betaFeedbackData.suggestions.length === 0) return '<p style="color: var(--text-secondary); font-size: 0.9rem;">No suggestions yet</p>';
    return betaFeedbackData.suggestions.map((sug, i) => `
        <div style="background: var(--surface); border: 1px solid var(--border); border-left: 3px solid var(--green); padding: 12px; border-radius: 8px; margin-bottom: 10px;">
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <div style="flex: 1;"><p style="font-weight: 600; margin-bottom: 5px;">${sug.description || 'No description'}</p><p style="font-size: 0.8rem; color: var(--text-secondary);">Priority: ${sug.priority || 'Not set'}</p></div>
                <button onclick="removeSuggestion(${i})" style="background: none; border: none; color: var(--red); cursor: pointer; font-size: 1.2rem;">√ó</button>
            </div>
        </div>
    `).join('');
}

function toggleBetaSection(sectionId) {
    const content = document.getElementById(`beta-section-${sectionId}`);
    const arrow = document.getElementById(`beta-arrow-${sectionId}`);
    if (openBetaSections.has(sectionId)) {
        openBetaSections.delete(sectionId);
        content.classList.remove('active');
        arrow.textContent = '‚ñº';
    } else {
        openBetaSections.add(sectionId);
        content.classList.add('active');
        arrow.textContent = '‚ñ≤';
    }
}
async function setBetaResult(itemId, result) {
    betaFeedbackData.test_results[itemId] = result;
    renderBetaFeedbackContent();
    await saveBetaFeedback();
}

async function setBetaRating(rating) {
    betaFeedbackData.overall_rating = rating;
    renderBetaFeedbackContent();
    await saveBetaFeedback();
}

async function setBetaRecommend(value) {
    betaFeedbackData.would_recommend = value;
    renderBetaFeedbackContent();
    await saveBetaFeedback();
}

async function setBetaComments(value) {
    betaFeedbackData.additional_comments = value;
    await saveBetaFeedback();
}

function addBug() {
    const description = prompt('Describe the bug:');
    if (!description) return;
    const severity = prompt('Severity (Low, Medium, High):') || 'Medium';
    betaFeedbackData.bugs.push({ description, severity });
    renderBetaFeedbackContent();
    saveBetaFeedback();
}

function removeBug(index) {
    betaFeedbackData.bugs.splice(index, 1);
    renderBetaFeedbackContent();
    saveBetaFeedback();
}

function addSuggestion() {
    const description = prompt('Describe your suggestion:');
    if (!description) return;
    const priority = prompt('Priority (Nice to have, Want, Need):') || 'Want';
    betaFeedbackData.suggestions.push({ description, priority });
    renderBetaFeedbackContent();
    saveBetaFeedback();
}

function removeSuggestion(index) {
    betaFeedbackData.suggestions.splice(index, 1);
    renderBetaFeedbackContent();
    saveBetaFeedback();
}

async function saveBetaFeedback() {
    if (!useCloud || !currentUser) return;
    const feedbackData = {
        user_id: currentUser.id,
        user_email: currentUser.email || localStorage.getItem('user_email'),
        device_info: navigator.userAgent,
        test_results: betaFeedbackData.test_results,
        bugs: betaFeedbackData.bugs,
        suggestions: betaFeedbackData.suggestions,
        overall_rating: betaFeedbackData.overall_rating,
        would_recommend: betaFeedbackData.would_recommend,
        additional_comments: betaFeedbackData.additional_comments,
        updated_at: new Date().toISOString()
    };
    try {
        if (betaFeedbackId) {
            await sb_client.from('beta_feedback').update(feedbackData).eq('id', betaFeedbackId);
        } else {
            const { data } = await sb_client.from('beta_feedback').insert(feedbackData).select().single();
            if (data) betaFeedbackId = data.id;
        }
    } catch (e) {
        console.error('Error saving beta feedback:', e);
    }
}

async function submitBetaFeedback() {
    await saveBetaFeedback();
    const totalTests = BETA_TEST_SECTIONS.reduce((sum, s) => sum + s.items.length, 0);
    const completedTests = Object.keys(betaFeedbackData.test_results).length;
    closeBetaFeedback();
    showToast(`‚úì Feedback saved! (${completedTests}/${totalTests} tests completed)`);
}


        
        // ==================== CONFIGURATION ====================
        const SUPABASE_URL = 'https://eiigbmrjtwndanywrcqp.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVpaWdibXJqdHduZGFueXdyY3FwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcyMDQyMzQsImV4cCI6MjA4Mjc4MDIzNH0.bHCDscs-aeSukDeXAf9kuRC12WBC3zSqIQia-8cIc3s';
        
        let sb_client = null;
        let currentUser = null;
        let useCloud = false;

        // ==================== STATE ====================
        let samples = [];
        let settings = { defaultDays: 14 };
        let currentView = 'list';
        let currentFilter = 'all';
        let currentSort = 'dueDate';
        let searchQuery = '';
        let selectedSamples = new Set();
        let editId = null;
        let tempTags = [];
        let tempPhotos = [];
        let calendarDate = new Date();
        let userTier = 'free';
        let tierLimits = {
            free: { samples: 5, photos: 1 },
            basic: { samples: 999999, photos: 2 },
            pro: { samples: 999999, photos: 3 }
        };
        let hapticEnabled = false;
        let compactMode = false;
        let condensedView = false;
        let expandedCards = new Set();

        // ==================== INITIALIZATION ====================
        async function initSupabase() {
            try {
                sb_client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                await signInAnonymously();
            } catch (e) {
                console.log('Supabase init failed, using local storage');
                useCloud = false;
                showApp();
            }
        }

        // ==================== SUBSCRIPTION TIER ====================
        async function loadUserTier() {
            if (!useCloud || !currentUser) {
                console.log('‚ùå No cloud or no user, defaulting to free');
                userTier = 'free';
                return;
            }
            
            try {
                console.log('üì° Querying database for user:', currentUser.id);
                
                const { data, error } = await sb_client
                    .from('users')
                    .select('subscription_tier')
                    .eq('id', currentUser.id)
                    .single();
                
                console.log('üìä Database response:', { data, error });
                
                if (error && error.code === 'PGRST116') {
                    console.log('‚ö†Ô∏è User not in database, creating...');
                    await sb_client
                        .from('users')
                        .insert({
                            id: currentUser.id,
                            email: currentUser.email,
                            subscription_tier: 'free'
                        });
                    userTier = 'free';
                } else if (error) {
                    console.error('‚ùå Load tier error:', error);
                    userTier = 'free';
                } else {
                    userTier = data?.subscription_tier || 'free';
                    console.log('‚úì User tier loaded:', userTier);
                }
                
                updateUIForTier();
            } catch (e) {
                console.error('üí• Load tier failed:', e);
                userTier = 'free';
            }
        }

        function updateUIForTier() {
            const calendarBtn = document.getElementById('view-calendar');
            if (calendarBtn && userTier === 'free') {
                calendarBtn.innerHTML = 'üìÖ Calendar View <span class="pro-badge">üíé BASIC</span>';
            }
            
            updateCloudStatus();
        }

        // ==================== AUTHENTICATION ====================
     async function signInAnonymously() {
    const hasSession = await checkExistingSession();
    if (!hasSession) {
        document.getElementById('landingPage').classList.remove('hidden');
    }
}

        function showAuth(mode) {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'authModal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 400px;">
                    <div class="modal-header">
                        <h2 class="modal-title">${mode === 'signup' ? 'Create Account' : 'Sign In'}</h2>
                        <button class="modal-close" onclick="closeAuthModal()">√ó</button>
                    </div>
                    <p style="color: var(--text-secondary); margin-bottom: 20px; text-align: center;">
                        ${mode === 'signup' ? 'Create a free account to sync your data across all devices' : 'Sign in to access your samples'}
                    </p>
                    
                    <div id="authForm">
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" id="authEmail" class="form-input" placeholder="your@email.com" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Password</label>
                            <div style="position: relative;">
                                <input type="password" id="authPassword" class="form-input" placeholder="Min 6 characters" required style="padding-right: 45px;">
                                <button type="button" onclick="togglePasswordVisibility('authPassword', this)" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 1.2rem;">üëÅÔ∏è</button>
                            </div>
                        </div>
                        ${mode === 'signup' ? `
                        <div class="form-group">
                            <label class="form-label">Confirm Password</label>
                            <div style="position: relative;">
                                <input type="password" id="authConfirm" class="form-input" placeholder="Confirm your password" required style="padding-right: 45px;">
                                <button type="button" onclick="togglePasswordVisibility('authConfirm', this)" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 1.2rem;">üëÅÔ∏è</button>
                            </div>
                        </div>
                        ` : ''}
                        
                        <div id="authError" style="color: var(--red); font-size: 0.85rem; margin-bottom: 10px; display: none;"></div>
                        <button class="row-btn btn-full-width" onclick="handleAuth('${mode}')" style="margin-bottom: 10px;">
                            ${mode === 'signup' ? 'Create Account' : 'Sign In'}
                        </button>
                        <button class="row-btn btn-secondary" onclick="closeAuthModal(); showAuth('${mode === 'signup' ? 'signin' : 'signup'}')">
                            ${mode === 'signup' ? 'Already have an account? Sign In' : 'Need an account? Sign Up'}
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function closeAuthModal() {
    const modal = document.getElementById('authModal');
    if (modal) modal.remove();
}
        
     async function handleAuth(mode) {
    const email = document.getElementById('authEmail').value;
    const password = document.getElementById('authPassword').value;
    const errorDiv = document.getElementById('authError');
    
    if (!email || !password) {
        errorDiv.textContent = 'Please enter email and password';
        errorDiv.style.display = 'block';
        return;
    }
    
    if (password.length < 6) {
        errorDiv.textContent = 'Password must be at least 6 characters';
        errorDiv.style.display = 'block';
        return;
    }
    
    if (mode === 'signup') {
        const confirmPassword = document.getElementById('authConfirm').value;
        if (password !== confirmPassword) {
            errorDiv.textContent = 'Passwords do not match';
            errorDiv.style.display = 'block';
            return;
        }
    }
    
    try {
        let data, error;
        
        if (mode === 'signup') {
            const result = await sb_client.auth.signUp({ email, password });
            data = result.data;
            error = result.error;
            
            if (error && data?.user) {
                console.log('User may exist, attempting sign in...');
                const signInResult = await sb_client.auth.signInWithPassword({ email, password });
                data = signInResult.data;
                error = signInResult.error;
            }
        } else {
            const result = await sb_client.auth.signInWithPassword({ email, password });
            data = result.data;
            error = result.error;
        }
        
        if (error) throw error;
        
        if (data.user) {
            // Store email for display purposes only
            localStorage.setItem('user_email', email);
            
            currentUser = data.user;
            useCloud = true;
            
            closeAuthModal();
            
            if (mode === 'signup') {
                await migrateToCloud();
            }
            
            await loadUserTier();
            await loadFromCloud();
            showApp();
            render();
            renderCalendar();
            
            if (mode === 'signup') {
                setTimeout(() => {
                    const btn = document.getElementById('floatingInstallBtn');
                    if (btn && !window.matchMedia('(display-mode: standalone)').matches) {
                        btn.style.display = 'block';
                    }
                }, 3000);
            }
        }
    } catch (e) {
        console.error('Auth error:', e);
        errorDiv.textContent = mode === 'signup' ? 'Sign up failed. Email may already be in use.' : 'Invalid email or password';
        errorDiv.style.display = 'block';
    }
}
        
        async function signOut() {
    if (confirm('Sign out? Your data will remain safely in the cloud.')) {
        await sb_client.auth.signOut();
        localStorage.removeItem('user_email');
        currentUser = null;
        useCloud = false;
        samples = [];
        window.location.reload();
    }
}
        // ==================== CLOUD SYNC ====================
     async function migrateToCloud() {
            if (!useCloud || !currentUser) return;
            
            const localSamples = JSON.parse(localStorage.getItem('tiktok_samples') || '[]');
            const localSettings = JSON.parse(localStorage.getItem('tiktok_settings') || '{}');
            
            if (localSamples.length > 0 || Object.keys(localSettings).length > 0) {
                samples = localSamples;
                settings = { ...settings, ...localSettings };
                await saveToCloud();
            }
        }

        async function saveToCloud() {
            if (!useCloud || !currentUser || !sb_client) return;
            
            try {
                const { error } = await sb_client
                    .from('sample_tracker_data')
                    .upsert({
                        user_id: currentUser.id,
                        samples: samples,
                        settings: settings,
                        updated_at: new Date().toISOString()
                    }, { 
                        onConflict: 'user_id' 
                    });
                
                if (error) throw error;
            } catch (e) {
                console.error('Save to cloud failed:', e);
            }
        }
        async function loadFromCloud() {
            if (!useCloud || !currentUser || !sb_client) return;
            
            try {
                const { data, error } = await sb_client
                    .from('sample_tracker_data')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .single();
                
                if (error && error.code !== 'PGRST116') throw error;
                
                if (data) {
                    samples = data.samples || [];
                    settings = data.settings || { defaultDays: 14 };
                }
            } catch (e) {
                console.error('Load from cloud failed:', e);
            }
        }

        // ==================== UI STATE ====================
        function showLanding() {
            if (currentUser) {
                showApp();
            } else {
                document.getElementById('landingPage').classList.remove('hidden');
                document.getElementById('landingPage').classList.add('active');
                document.getElementById('appContainer').classList.remove('active');
            }
        }

        function showApp() {
    document.getElementById('landingPage').classList.add('hidden');
    document.getElementById('landingPage').classList.remove('active');
    document.getElementById('appContainer').classList.add('active');
    
    loadUserTier().then(() => {
        render();
        renderCalendar();
        updateStats();
        
        // Check for due notifications after a short delay
        setTimeout(() => {
            checkDueNotifications();
        }, 500);
    });
}

        async function checkExistingSession() {
            try {
                const { data: { session }, error } = await sb_client.auth.getSession();
                
                if (session && session.user) {
                    currentUser = {
                        id: session.user.id,
                        email: session.user.email
                    };
                    
                    useCloud = true;
                    
                    console.log('Auto-signed in:', currentUser.email);
                    
                    await loadUserTier();
                    await loadFromCloud();
                    showApp();
                    
                    return true;
                }
                
                return false;
            } catch (error) {
                console.error('Session check error:', error);
                return false;
            }
        }

        // ==================== THEME HANDLING ====================
        function toggleTheme(isDark) {
            triggerHaptic();
            const html = document.documentElement;
            if (isDark) {
                html.setAttribute('data-theme', 'dark');
                localStorage.setItem('theme', 'dark');
            } else {
                html.removeAttribute('data-theme');
                localStorage.setItem('theme', 'light');
            }
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
                document.getElementById('darkModeToggle').checked = true;
            }
        }

        // ==================== HAPTIC & COMPACT ====================
        function toggleHaptic(enabled) {
            hapticEnabled = enabled;
            localStorage.setItem('haptic', enabled);
            if (enabled) triggerHaptic();
        }

        function triggerHaptic() {
            if (hapticEnabled && navigator.vibrate) {
                navigator.vibrate(15);
            }
        }

        function toggleCompact(enabled) {
            triggerHaptic();
            compactMode = enabled;
            localStorage.setItem('compact', enabled);
            if (enabled) {
                document.body.classList.add('compact-mode');
            } else {
                document.body.classList.remove('compact-mode');
            }
        }

              
        
        // ==================== CONDENSED VIEW FUNCTIONS ====================
        function setCardView(mode) {
    triggerHaptic();
    const expandedBtn = document.getElementById('expandedViewBtn');
    const condensedBtn = document.getElementById('condensedViewBtn');
    
    if (mode === 'condensed') {
        condensedView = true;
        expandedCards.clear();
        condensedBtn.classList.add('active');
        expandedBtn.classList.remove('active');
    } else {
        condensedView = false;
        expandedBtn.classList.add('active');
        condensedBtn.classList.remove('active');
    }
    
    render();
}
        function toggleCard(id) {
            triggerHaptic();
            if (expandedCards.has(id)) {
                expandedCards.delete(id);
            } else {
                expandedCards.add(id);
            }
            render();
        }

        function showInstallModal() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'installModal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 400px; text-align: center;">
                    <div style="font-size: 4rem; margin-bottom: 15px;">üì±</div>
                    <h2 style="font-weight: 800; font-size: 1.5rem; margin-bottom: 10px;">Install SampleFlow</h2>
                    <p style="color: var(--text-secondary); margin-bottom: 25px;">Add to your home screen for quick access!</p>
                    <button class="row-btn btn-full-width" onclick="installApp()" style="margin-bottom: 10px;">‚¨áÔ∏è Install Now</button>
                    <button class="row-btn btn-secondary" onclick="dismissInstall()">Maybe Later</button>
                </div>
            `;
            document.body.appendChild(modal);
        }

       
        function dismissInstall() {
            localStorage.setItem('install_dismissed', 'true');
            const modal = document.getElementById('installModal');
            if (modal) modal.remove();
        }

        function showPrivacyFromLanding() {
            document.getElementById('privacyModal').classList.add('active');
        }

        function showHelpFromLanding() {
            document.getElementById('helpModal').classList.add('active');
        }

        // ==================== STORAGE ====================
        async function saveSamples() {
            if (useCloud) {
                await saveToCloud();
            } else {
                localStorage.setItem('tiktok_samples', JSON.stringify(samples));
            }
        }

        async function saveSettings() {
            settings.defaultDays = parseInt(document.getElementById('defaultDays').value);
            if (useCloud) {
                await saveToCloud();
            } else {
                localStorage.setItem('tiktok_settings', JSON.stringify(settings));
            }
        }

        // ==================== RESET ====================
        function openResetModal() {
            document.getElementById('resetModal').classList.add('active');
        }

        function closeResetModal() {
            document.getElementById('resetModal').classList.remove('active');
        }

        function confirmReset() {
            localStorage.clear();
            samples = [];
            window.location.reload();
        }

        // ==================== WINDOW LOAD ====================
        window.onload = async () => {
            document.getElementById('landingPage').classList.remove('hidden');

            loadTheme();
            
            const savedHaptic = localStorage.getItem('haptic') === 'true';
            hapticEnabled = savedHaptic;
            document.getElementById('hapticToggle').checked = savedHaptic;

            const savedCompact = localStorage.getItem('compact') === 'true';
            toggleCompact(savedCompact);
            document.getElementById('compactToggle').checked = savedCompact;

            try { 
                samples = JSON.parse(localStorage.getItem('tiktok_samples')) || []; 
                settings = JSON.parse(localStorage.getItem('tiktok_settings')) || settings;
                document.getElementById('defaultDays').value = settings.defaultDays;
                
                const savedReminderDays = localStorage.getItem('reminder_days');
                if (savedReminderDays) {
                    document.getElementById('reminderDays').value = savedReminderDays;
                }
                
                const notifToggle = document.getElementById('notificationsToggle');
                if (Notification.permission === 'granted') {
                    notifToggle.checked = true;
                    document.getElementById('reminderSettings').style.display = 'block';
                }
            } catch(e) { 
                samples = []; 
            }
            
            try {
                sb_client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                await checkExistingSession();
            } catch(e) {
                console.error("Critical Init Error:", e);
            }
        };
        
        // ==================== STATUS INFO ====================
        function getStatusInfo(s) {
            if (s.done) return { status: 'completed', days: 0, percent: 100, color: '#E0E0E0', text: 'Posted' };
            const start = new Date(s.date + 'T00:00:00').getTime();
            const now = new Date();
            now.setHours(0,0,0,0);
            const end = new Date(start + s.limit * 86400000);
            const total = s.limit;
            const elapsed = Math.floor((now.getTime() - start) / 86400000);
            const remaining = total - elapsed;
            const percent = Math.min(100, Math.max(0, (elapsed / total) * 100));
            
            if (remaining < 0) return { status: 'overdue', days: remaining, percent, color: '#FF3B30', text: `${Math.abs(remaining)}d overdue` };
            if (remaining <= 3) return { status: 'urgent', days: remaining, percent, color: '#FFB300', text: `${remaining}d left` };
            return { status: 'good', days: remaining, percent, color: '#00C853', text: `${remaining}d left` };
        }

        function updateStats() {
            const completedSamples = samples.filter(s => s.done);
            const activeSamples = samples.filter(s => !s.done);
            const stats = { overdue: 0, urgent: 0, good: 0 };
            activeSamples.forEach(s => {
                const info = getStatusInfo(s);
                if (info.status === 'overdue') stats.overdue++;
                else if (info.status === 'urgent') stats.urgent++;
                else stats.good++;
            });
            document.getElementById('statOverdue').innerText = stats.overdue;
            document.getElementById('statUrgent').innerText = stats.urgent;
            document.getElementById('statGood').innerText = stats.good;
            document.getElementById('statAll').innerText = samples.length;
            document.getElementById('statCompleted').innerText = completedSamples.length;
        }

        // ==================== FILTERING & SORTING ====================
        function toggleFilterDropdown() {
            const dropdown = document.getElementById('filterDropdown');
            const sortDropdown = document.getElementById('sortDropdown');
            const filterBtn = document.getElementById('filterToggleBtn');
            const sortBtn = document.getElementById('sortToggleBtn');
            
            sortDropdown.style.display = 'none';
            sortBtn.classList.remove('active');
            
            if (dropdown.style.display === 'block') {
                dropdown.style.display = 'none';
                filterBtn.classList.remove('active');
            } else {
                dropdown.style.display = 'block';
                filterBtn.classList.add('active');
            }
        }

        function toggleSortDropdown() {
            const dropdown = document.getElementById('sortDropdown');
            const filterDropdown = document.getElementById('filterDropdown');
            const filterBtn = document.getElementById('filterToggleBtn');
            const sortBtn = document.getElementById('sortToggleBtn');
            
            filterDropdown.style.display = 'none';
            filterBtn.classList.remove('active');
            
            if (dropdown.style.display === 'block') {
                dropdown.style.display = 'none';
                sortBtn.classList.remove('active');
            } else {
                dropdown.style.display = 'block';
                sortBtn.classList.add('active');
            }
        }

        function setFilter(f) {
            triggerHaptic();
            currentFilter = f;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('f-' + f).classList.add('active');
            
            const headings = {
                'all': 'üì¶ All Samples',
                'overdue': 'üî• Overdue Samples',
                'urgent': '‚è≥ Due Soon',
                'good': '‚úÖ On Track',
                'completed': 'üèÅ Posted Samples'
            };
            const heading = document.getElementById('filterHeading');
            heading.textContent = headings[f];
            heading.style.display = 'block';
            
            document.getElementById('filterDropdown').style.display = 'none';
            document.getElementById('filterToggleBtn').classList.remove('active');
            render();
        }

        function setSort(s) {
            currentSort = s;
            document.getElementById('sortDropdown').style.display = 'none';
            document.getElementById('sortToggleBtn').classList.remove('active');
            render();
        }

        function handleSearch() {
            searchQuery = document.getElementById('searchBar').value.toLowerCase();
            render();
        }

        function getFilteredSamples() {
            let filtered = samples.filter(s => {
                const matchSearch = !searchQuery || 
                    s.product.toLowerCase().includes(searchQuery) || 
                    s.brand.toLowerCase().includes(searchQuery);
                if (!matchSearch) return false;
                
                const info = getStatusInfo(s);
                if (currentFilter === 'all') return true;
                if (currentFilter === 'completed') return s.done;
                if (currentFilter === 'overdue') return !s.done && info.status === 'overdue';
                if (currentFilter === 'urgent') return !s.done && info.status === 'urgent';
                if (currentFilter === 'good') return !s.done && info.status === 'good';
                return true;
            });
            
            filtered.sort((a, b) => {
                if (currentSort === 'brand') return a.brand.localeCompare(b.brand);
                if (currentSort === 'received') return new Date(b.date) - new Date(a.date);
                const aInfo = getStatusInfo(a);
                const bInfo = getStatusInfo(b);
                if (a.done && !b.done) return 1;
                if (!a.done && b.done) return -1;
                return aInfo.days - bInfo.days;
            });
            
            return filtered;
        }

        // ==================== SELECTION & BATCH ====================
        function toggleSelection(id) {
            triggerHaptic();
            if (selectedSamples.has(id)) {
                selectedSamples.delete(id);
            } else {
                selectedSamples.add(id);
            }
            updateBatchBar();
            render();
        }

        function clearSelection() {
            selectedSamples.clear();
            updateBatchBar();
            render();
        }

        function updateBatchBar() {
            const bar = document.getElementById('batchBar');
            const count = document.getElementById('selectedCount');
            count.innerText = selectedSamples.size;
            if (selectedSamples.size > 0) {
                bar.classList.add('active');
            } else {
                bar.classList.remove('active');
            }
        }

        async function batchMarkDone() {
    triggerHaptic();
    samples = samples.map(s => {
        if (selectedSamples.has(s.id)) {
            // Sync both statuses: Mark as Done AND check the 'posted' box
            return {
                ...s, 
                done: true, 
                checklist: { ...s.checklist, posted: true }
            };
        }
        return s;
    });
    selectedSamples.clear();
    await saveSamples();
    render();
    updateBatchBar();
}

        async function batchDelete() {
            triggerHaptic();
            if (confirm(`Delete ${selectedSamples.size} samples?`)) {
                samples = samples.filter(s => !selectedSamples.has(s.id));
                selectedSamples.clear();
                await saveSamples();
                render();
                renderCalendar();
                updateBatchBar();
            }
        }

        // ==================== RENDER ====================
        function render() {
    updateStats();
    updateCloudStatus();
    const filtered = getFilteredSamples();
    const grid = document.getElementById('sampleGrid');
    
    if (filtered.length === 0) {
        grid.innerHTML = '<div class="empty-state"><p style="font-size: 3rem; margin-bottom: 10px;">üì¶</p><p>No samples match this filter</p><p style="font-size: 0.9rem; margin-top: 5px;">Try a different filter or add a new sample</p></div>';
        return;
    }
    
    grid.innerHTML = filtered.map(s => renderSampleCard(s)).join('');
    
    // Re-check notifications (but don't override dismissal)
    // Only show if not already dismissed today
    const today = new Date().toISOString().split('T')[0];
    const dismissedDate = localStorage.getItem('notification_dismissed_date');
    if (dismissedDate !== today) {
        checkDueNotifications();
    }
}

        function renderSampleCard(s) {
            if (!s.checklist) s.checklist = { filmed: false, edited: false, posted: false };
            const info = getStatusInfo(s);
            const isSelected = selectedSamples.has(s.id);
            const dueDate = new Date(new Date(s.date).getTime() + s.limit * 86400000);
            const isExpanded = expandedCards.has(s.id);
            const isCollapsed = condensedView && !isExpanded;
            
            // Collapsed summary view
            if (isCollapsed) {
                const thumbnail = s.photos && s.photos.length > 0 
                    ? `<img src="${s.photos[0]}" class="summary-thumbnail" alt="${s.product}">`
                    : `<div class="summary-thumbnail">üì¶</div>`;
                
                return `
                    <div class="sample-card collapsed" onclick="toggleCard('${s.id}')">
                        <div class="sample-summary">
                            ${thumbnail}
                            <div class="summary-info">
                                <div class="summary-brand">${s.brand}</div>
                                <div class="summary-product">${s.product}</div>
                                <div class="summary-meta">
                                    <span class="summary-badge ${info.status}">${info.text}</span>
                                    <span class="summary-date">${new Date(s.date).toLocaleDateString()}</span>
                                </div>
                            </div>
                            <div class="card-expand-icon">‚ñº</div>
                        </div>
                    </div>
                `;
            }
            
            // Expanded full view
            return `
                <div class="sample-card ${isSelected ? 'selecting' : ''}">
                    ${condensedView ? `
                        <div class="sample-summary" onclick="toggleCard('${s.id}')" style="border-bottom: 1px solid var(--border); margin-bottom: 12px; cursor: pointer;">
                            ${s.photos && s.photos.length > 0 
                                ? `<img src="${s.photos[0]}" class="summary-thumbnail" alt="${s.product}">`
                                : `<div class="summary-thumbnail">üì¶</div>`
                            }
                            <div class="summary-info">
                                <div class="summary-brand">${s.brand}</div>
                                <div class="summary-product">${s.product}</div>
                                <div class="summary-meta">
                                    <span class="summary-badge ${info.status}">${info.text}</span>
                                    <span class="summary-date">${new Date(s.date).toLocaleDateString()}</span>
                                </div>
                            </div>
                            <div class="card-expand-icon">‚ñº</div>
                        </div>
                    ` : ''}
                    <div class="card-body card-details">
                        <div class="card-header">
                            <div>
                                <div class="brand-name">${s.brand}</div>
                                <div class="product-name">${s.product}</div>
                            </div>
                            <input type="checkbox" class="card-checkbox" ${isSelected ? 'checked' : ''} onchange="toggleSelection('${s.id}')">
                        </div>
                        
                        <div class="days-badge ${info.status}">${info.text}</div>
                        
                        ${s.tags && s.tags.length ? `<div class="tags-row">${s.tags.map(t => `<span class="tag">${t}</span>`).join('')}</div>` : ''}
                        
                        ${s.photos && s.photos.length ? `<div class="photo-row">${s.photos.map(p => `<img src="${p}" class="photo-thumb" onclick="viewPhoto('${p}')">`).join('')}</div>` : ''}
                        
                        ${s.notes ? `<div class="notes-section">${s.notes}</div>` : ''}
                        
                        <div class="checklist">
                            <button class="progress-toggle ${s.checklist.filmed ? 'active' : ''}" onclick="toggleCheckbox('${s.id}', 'filmed')">
                                <span class="toggle-icon">üé•</span>
                                <span class="toggle-label">Filmed</span>
                                ${s.checklist.filmed ? '<span class="toggle-check">‚úì</span>' : ''}
                            </button>
                            <button class="progress-toggle ${s.checklist.edited ? 'active' : ''}" onclick="toggleCheckbox('${s.id}', 'edited')">
                                <span class="toggle-icon">‚úÇÔ∏è</span>
                                <span class="toggle-label">Edited</span>
                                ${s.checklist.edited ? '<span class="toggle-check">‚úì</span>' : ''}
                            </button>
                            <button class="progress-toggle ${s.checklist.posted ? 'active' : ''}" onclick="toggleCheckbox('${s.id}', 'posted')">
                                <span class="toggle-icon">üì±</span>
                                <span class="toggle-label">Posted</span>
                                ${s.checklist.posted ? '<span class="toggle-check">‚úì</span>' : ''}
                            </button>
                        </div>
                        
                        <div class="progress-container">
                            <div class="progress-fill" style="width: ${info.percent}%; background: ${info.color};"></div>
                        </div>
                        
                        <div class="meta-grid">
                            <div>
                                <span class="meta-label">Received</span>
                                <span class="meta-value">${new Date(s.date).toLocaleDateString()}</span>
                            </div>
                            <div>
                                <span class="meta-label">Due Date</span>
                                <span class="meta-value">${dueDate.toLocaleDateString()}</span>
                            </div>
                        </div>
                        
                        <div class="action-container">
                            ${s.link && !s.done ? `<button class="row-btn btn-secondary" onclick="openBrowser('${s.link}')">üîó View Product</button>` : ''}
                            ${(userTier === 'basic' || userTier === 'pro') && !s.done ? 
                                '<button class="row-btn" style="background: linear-gradient(135deg, #9C27B0, #BA68C8); color: white; margin-bottom: 8px;" onclick="generateScript(\''+s.id+'\')">‚ú® Generate Script</button>' 
                                : ''
                            }
                            ${!s.done && userTier === 'pro' ? 
                                '<button class="row-btn" style="background: linear-gradient(135deg, #FE2C55, #FF6B8A); color: white; margin-bottom: 8px;" onclick="readyToFilm(\''+s.id+'\')">üé• Ready to Film</button>' 
                                : ''
                            }
                            ${s.done ? '<button class="row-btn btn-completed">‚úì Content Archived</button>' : ''}
                            <div class="btn-row-2">
                                <button class="row-btn btn-secondary" onclick="openModal('${s.id}')">‚úèÔ∏è Edit</button>
                                <button class="row-btn btn-secondary" onclick="deleteSample('${s.id}')">üóë Delete</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // ==================== SAMPLE ACTIONS ====================
        async function markDone(id) {
            triggerHaptic();
            samples = samples.map(s => s.id === id ? {...s, done: true} : s);
            await saveSamples();
            render();
        }

        async function deleteSample(id) {
            triggerHaptic();
            if (confirm('Delete this sample?')) {
                samples = samples.filter(s => s.id !== id);
                await saveSamples();
                render();
                renderCalendar();
            }
        }
        
        async function toggleCheckbox(id, field) {
    triggerHaptic();
    samples = samples.map(s => {
        if (s.id === id) {
            const updatedChecklist = {...s.checklist, [field]: !s.checklist[field]};
            
            // Logic: If they check "Posted", the card is automatically marked "Done" (Archived).
            // If they uncheck it, it comes back to the active list.
            let isDone = s.done;
            if (field === 'posted') {
                isDone = updatedChecklist.posted;
            }

            return {...s, checklist: updatedChecklist, done: isDone};
        }
        return s;
    });
    render();
    saveSamples();
}
        
        // ==================== MODAL ====================
        function openModal(id = null) {
            if (!id && userTier === 'free' && samples.length >= 5) {
                showUpgradeModal(
                    'You\'ve reached the 5 sample limit!',
                    'Upgrade to Basic for unlimited samples + calendar view',
                    'basic'
                );
                return;
            }
            
            editId = id;
            tempTags = [];
            tempPhotos = [];
            const form = document.getElementById('sampleForm');
            form.reset();
            document.getElementById('dateReceived').valueAsDate = new Date();
            document.getElementById('daysLimit').value = settings.defaultDays;
            document.getElementById('sampleReminderDays').value = '';
            
            if (id) {
                const s = samples.find(x => x.id === id);
                document.getElementById('modalTitle').innerText = 'Edit Sample';
                document.getElementById('productName').value = s.product;
                document.getElementById('brandName').value = s.brand;
                document.getElementById('dateReceived').value = s.date;
                document.getElementById('daysLimit').value = s.limit;
                document.getElementById('shopLink').value = s.link || '';
                document.getElementById('notes').value = s.notes || '';
                document.getElementById('sampleReminderDays').value = s.reminderDays !== undefined ? s.reminderDays : '';
                tempTags = s.tags || [];
                tempPhotos = s.photos || [];
                renderTags();
                renderPhotoGrid();
            } else {
                document.getElementById('modalTitle').innerText = 'Add Sample';
                renderTags();
                renderPhotoGrid();
            }
            
            calcDuePreview();
            document.getElementById('sampleModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('sampleModal').classList.remove('active');
        }

        async function handleSave(e) {
            e.preventDefault();
            try {
                const reminderDaysValue = document.getElementById('sampleReminderDays').value;
                const newItem = {
                    id: editId || Date.now().toString(),
                    product: document.getElementById('productName').value,
                    brand: document.getElementById('brandName').value,
                    date: document.getElementById('dateReceived').value,
                    limit: parseInt(document.getElementById('daysLimit').value),
                    link: document.getElementById('shopLink').value,
                    notes: document.getElementById('notes').value,
                    tags: tempTags,
                    photos: tempPhotos,
                    reminderDays: reminderDaysValue === '' ? undefined : parseInt(reminderDaysValue),
                    checklist: editId ? samples.find(x => x.id === editId).checklist : { filmed: false, edited: false, posted: false },
                    done: editId ? samples.find(x => x.id === editId).done : false
                };
                
                if (editId) {
                    samples = samples.map(x => x.id === editId ? newItem : x);
                } else {
                    samples.unshift(newItem);
                }
                
                await saveSamples();
                render();
                renderCalendar();
            } catch (err) {
                console.error(err);
                alert("Error saving: " + err.message);
            } finally {
                closeModal();
            }
        }

        function calcDuePreview() {
            const date = document.getElementById('dateReceived').value;
            const days = parseInt(document.getElementById('daysLimit').value);
            if (date && days) {
                const dueDate = new Date(new Date(date).getTime() + days * 86400000);
                document.getElementById('dueCalcDisplay').innerText = `Due: ${dueDate.toLocaleDateString()}`;
            }
        }

        // ==================== TAGS ====================
        function handleTagInput(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const val = e.target.value.trim();
                if (val && !tempTags.includes(val)) {
                    tempTags.push(val);
                    e.target.value = '';
                    renderTags();
                }
            }
        }

        function removeTag(tag) {
            tempTags = tempTags.filter(t => t !== tag);
            renderTags();
        }

        function renderTags() {
            const container = document.getElementById('tagsContainer');
            const input = document.getElementById('tagInput');
            const existingTags = tempTags.map(t => 
                `<span class="tag-input-item">${t}<span class="tag-remove" onclick="removeTag('${t}')">√ó</span></span>`
            ).join('');
            container.innerHTML = existingTags;
            container.appendChild(input);
        }

        // ==================== PHOTOS ====================
        function handlePhotoUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
    
            const photoLimit = tierLimits[userTier].photos;
            
            if (tempPhotos.length >= photoLimit) {
                const upgradeMsg = userTier === 'free' 
                    ? 'Free users can upload 1 photo per sample. Upgrade to Basic for 2 photos!'
                    : 'Basic users can upload 2 photos. Upgrade to Pro for 3 photos!';
                
                const targetTier = userTier === 'free' ? 'basic' : 'pro';
                
                showUpgradeModal(
                    `You've reached the ${photoLimit} photo limit!`,
                    upgradeMsg,
                    targetTier
                );
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (ev) => {
                tempPhotos.push(ev.target.result);
                renderPhotoGrid();
            };
            reader.readAsDataURL(file);
        }

        function removePhoto(index) {
            tempPhotos.splice(index, 1);
            renderPhotoGrid();
        }

        function renderPhotoGrid() {
            const grid = document.getElementById('photoGrid');
            const items = tempPhotos.map((p, i) => 
                `<div class="photo-upload-item">
                    <img src="${p}">
                    <button class="photo-remove" onclick="removePhoto(${i})">√ó</button>
                </div>`
            ).join('');
            grid.innerHTML = items + `
                <label class="photo-upload-item">
                    <input type="file" accept="image/*" style="display:none" onchange="handlePhotoUpload(event)">
                    <span style="font-size: 2rem;">+</span>
                </label>
            `;
        }

        function viewPhoto(src) {
            document.getElementById('photoViewerImg').src = src;
            document.getElementById('photoViewerModal').classList.add('active');
        }

        function closePhotoViewer() {
            document.getElementById('photoViewerModal').classList.remove('active');
        }

        // ==================== CALENDAR ====================
       function setView(v) {
    if (v === 'calendar' && userTier === 'free') {
        showUpgradeModal(
            'Calendar View is a Basic feature!',
            'Upgrade to see all your deadlines in a monthly calendar view',
            'basic'
        );
        return;
    }
    
    triggerHaptic();
    currentView = v;
    
    document.getElementById('view-list').classList.toggle('active', v === 'list');
    document.getElementById('view-calendar').classList.toggle('active', v === 'calendar');
    
    if (v === 'list') {
        document.getElementById('listView').style.display = 'block';
        document.getElementById('calendarView').style.display = 'none';
    } else {
        document.getElementById('listView').style.display = 'none';
        document.getElementById('calendarView').style.display = 'block';
        renderCalendar();
    }
}
        function changeMonth(delta) {
            calendarDate.setMonth(calendarDate.getMonth() + delta);
            renderCalendar();
        }
        function formatDateLocal(date) {
    const d = new Date(date);
    return d.getFullYear() + '-' + 
           String(d.getMonth() + 1).padStart(2, '0') + '-' + 
           String(d.getDate()).padStart(2, '0');
}
        function renderCalendar() {
            const year = calendarDate.getFullYear();
            const month = calendarDate.getMonth();
            document.getElementById('calendarMonth').innerText = new Date(year, month).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const prevMonthDays = new Date(year, month, 0).getDate();
            
            let html = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(d => `<div class="calendar-header">${d}</div>`).join('');
            
            for (let i = firstDay - 1; i >= 0; i--) {
                html += `<div class="calendar-day other-month">${prevMonthDays - i}</div>`;
            }
            
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateStr = formatDateLocal(date);
                const dueSamples = samples.filter(s => {
                    const dueDate = new Date(new Date(s.date).getTime() + s.limit * 86400000);
                    return formatDateLocal(dueDate) === dateStr && !s.done;
                });
                
                const hasOverdue = dueSamples.some(s => getStatusInfo(s).status === 'overdue');
                const classes = dueSamples.length ? (hasOverdue ? 'has-items overdue' : 'has-items') : '';
                
                html += `<div class="calendar-day ${classes}" onclick="showDayDetails('${dateStr}')">
                    <span class="calendar-day-number">${day}</span>
                    ${dueSamples.length ? `<div class="calendar-day-dots">${dueSamples.slice(0, 3).map(() => '<div class="calendar-dot" style="background: var(--primary);"></div>').join('')}</div>` : ''}
                </div>`;
            }
            
            document.getElementById('calendarGrid').innerHTML = html;
        }

        function showDayDetails(dateStr) {
            const dueSamples = samples.filter(s => {
                const dueDate = new Date(new Date(s.date).getTime() + s.limit * 86400000);
                return formatDateLocal(dueDate) === dateStr && !s.done;
            });
            
            const details = document.getElementById('calendarDayDetails');
            if (dueSamples.length === 0) {
                details.innerHTML = '';
                return;
            }
            
            details.innerHTML = `
                <h3 style="font-weight: 700; margin-bottom: 15px;">Due on ${new Date(dateStr).toLocaleDateString()}</h3>
                ${dueSamples.map(s => renderSampleCard(s)).join('')}
            `;
        }

        // ==================== ANALYTICS ====================
        function openAnalytics() {
            if (userTier !== 'pro') {
                showUpgradeModal(
                    'Analytics Dashboard is a Pro feature!',
                    'Track your completion rates, overdue samples, and productivity stats',
                    'pro'
                );
                return;
            }
            
            const total = samples.length;
            const completed = samples.filter(s => s.done).length;
            const active = total - completed;
            const stats = { overdue: 0, urgent: 0, good: 0 };
            samples.filter(s => !s.done).forEach(s => {
                const info = getStatusInfo(s);
                if (info.status === 'overdue') stats.overdue++;
                else if (info.status === 'urgent') stats.urgent++;
                else stats.good++;
            });
            
            const content = `
                <div class="analytics-section">
                    <div class="analytics-title">Overview</div>
                    <div class="analytics-grid">
                        <div class="analytics-card">
                            <div class="analytics-number">${total}</div>
                            <div class="analytics-label">Total Samples</div>
                        </div>
                        <div class="analytics-card">
                            <div class="analytics-number">${completed}</div>
                            <div class="analytics-label">Completed</div>
                        </div>
                        <div class="analytics-card">
                            <div class="analytics-number">${active}</div>
                            <div class="analytics-label">Active</div>
                        </div>
                        <div class="analytics-card">
                            <div class="analytics-number">${total ? Math.round(completed/total*100) : 0}%</div>
                            <div class="analytics-label">Completion Rate</div>
                        </div>
                    </div>
                </div>
                <div class="analytics-section">
                    <div class="analytics-title">Active Samples</div>
                    <div class="analytics-grid">
                        <div class="analytics-card">
                            <div class="analytics-number" style="color: var(--red);">${stats.overdue}</div>
                            <div class="analytics-label">Overdue</div>
                        </div>
                        <div class="analytics-card">
                            <div class="analytics-number" style="color: var(--yellow);">${stats.urgent}</div>
                            <div class="analytics-label">Due Soon</div>
                        </div>
                        <div class="analytics-card" style="grid-column: span 2;">
                            <div class="analytics-number" style="color: var(--green);">${stats.good}</div>
                            <div class="analytics-label">On Track</div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('analyticsContent').innerHTML = content;
            document.getElementById('analyticsModal').classList.add('active');
        }

        function closeAnalytics() {
            document.getElementById('analyticsModal').classList.remove('active');
        }

        // ==================== SETTINGS ====================
        function openSettings() {
            updateCloudStatus();
            updateSettingsAccountInfo();
            document.getElementById('settingsModal').classList.add('active');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        function updateSettingsAccountInfo() {
            if (useCloud && currentUser) {
                const email = localStorage.getItem('user_email') || currentUser.email || 'Unknown';
                document.getElementById('settingsEmailDisplay').textContent = email;
                document.getElementById('settingsTierDisplay').textContent = userTier.charAt(0).toUpperCase() + userTier.slice(1);
            } else {
                document.getElementById('settingsEmailDisplay').textContent = 'Not signed in';
                document.getElementById('settingsTierDisplay').textContent = 'Free';
            }
        }

        function updateCloudStatus() {
            const statusDiv = document.getElementById('cloudStatus');
            const menuSignOutBtn = document.getElementById('menuSignOutBtn');
            const manageSubBtn = document.getElementById('manageSubBtn');
            
            if (useCloud && currentUser) {
                const userEmail = localStorage.getItem('user_email') || currentUser.email || 'Unknown';
                
                statusDiv.innerHTML = `
                    <p style="margin-bottom: 5px; font-weight: 700; color: var(--green);">‚úì Cloud Storage Active</p>
                    <p style="font-size: 0.85rem;">Signed in as: <strong>${userEmail}</strong></p>
                    <p style="font-size: 0.75rem; margin-top: 5px;">Data syncing across all your devices</p>
                `;
                statusDiv.style.background = '#E8F5E9';
                if (menuSignOutBtn) menuSignOutBtn.style.display = 'block';
                
                if (manageSubBtn) {
                    if (userTier === 'basic' || userTier === 'pro') {
                        manageSubBtn.style.display = 'block';
                    } else {
                        manageSubBtn.style.display = 'none';
                    }
                }
            } else {
                statusDiv.innerHTML = `
                    <p style="margin-bottom: 5px; font-weight: 700;">üíæ Using Local Storage</p>
                    <p style="font-size: 0.85rem;">Your data is saved in your browser only</p>
                    <p style="font-size: 0.75rem; margin-top: 5px;">Create an account to sync across devices</p>
                `;
                statusDiv.style.background = '#E3F2FD';
                if (menuSignOutBtn) menuSignOutBtn.style.display = 'none';
                if (manageSubBtn) manageSubBtn.style.display = 'none';
            }
        }

        function showCloudInfo() {
            document.getElementById('cloudInfoModal').classList.add('active');
        }

        function closeCloudInfo() {
            document.getElementById('cloudInfoModal').classList.remove('active');
        }

        // ==================== NOTIFICATIONS ====================
        async function toggleNotifications(enabled) {
            const reminderSettings = document.getElementById('reminderSettings');
            
            if (enabled) {
                if (!('Notification' in window)) {
                    alert('Your browser doesn\'t support notifications');
                    document.getElementById('notificationsToggle').checked = false;
                    return;
                }
                
                if (Notification.permission === 'granted') {
                    reminderSettings.style.display = 'block';
                } else if (Notification.permission !== 'denied') {
                    document.getElementById('notificationStatus').style.display = 'block';
                    const permission = await Notification.requestPermission();
                    document.getElementById('notificationStatus').style.display = 'none';
                    
                    if (permission === 'granted') {
                        reminderSettings.style.display = 'block';
                    } else {
                        document.getElementById('notificationsToggle').checked = false;
                        alert('Notifications blocked. Enable them in your browser settings.');
                    }
                } else {
                    document.getElementById('notificationsToggle').checked = false;
                    alert('Notifications are blocked. Please enable them in your browser settings.');
                }
            } else {
                reminderSettings.style.display = 'none';
            } 
        }

        // ==================== MENU ====================
        function toggleMenu() {
            document.getElementById('menuModal').classList.add('active');
        }

        function closeMenu() {
            document.getElementById('menuModal').classList.remove('active');
        }

        function openPrivacy() {
            document.getElementById('privacyModal').classList.add('active');
        }

        function closePrivacy() {
            document.getElementById('privacyModal').classList.remove('active');
        }

        function openHelp() {
            document.getElementById('helpModal').classList.add('active');
        }

        function closeHelp() {
            document.getElementById('helpModal').classList.remove('active');
        }

        function openInstall() {
            document.getElementById('installModal').classList.add('active');
        }

        function closeInstall() {
            document.getElementById('installModal').classList.remove('active');
        }

        function openSupport() {
            document.getElementById('supportModal').classList.add('active');
        }

        function closeSupport() {
            document.getElementById('supportModal').classList.remove('active');
        }

        // ==================== UTILITIES ====================
        function openBrowser(url) {
            document.getElementById('browserFrame').src = url;
            document.getElementById('browserOverlay').classList.add('active');
        }

        function closeBrowser() {
            document.getElementById('browserOverlay').classList.remove('active');
            document.getElementById('browserFrame').src = '';
        }

        function exportCSV() {
            if (userTier !== 'pro') {
                showUpgradeModal(
                    'Export to CSV is a Pro feature!',
                    'Download all your sample data as a spreadsheet',
                    'pro'
                );
                return;
            }
            
            const headers = ['Brand', 'Product', 'Received Date', 'Days to Post', 'Due Date', 'Status', 'Link', 'Notes', 'Tags', 'Filmed', 'Edited', 'Posted'];
            const rows = samples.map(s => {
                const dueDate = new Date(new Date(s.date).getTime() + s.limit * 86400000);
                const info = getStatusInfo(s);
                return [
                    s.brand,
                    s.product,
                    s.date,
                    s.limit,
                    dueDate.toISOString().split('T')[0],
                    s.done ? 'Completed' : info.text,
                    s.link || '',
                    s.notes || '',
                    (s.tags || []).join('; '),
                    s.checklist.filmed ? 'Yes' : 'No',
                    s.checklist.edited ? 'Yes' : 'No',
                    s.checklist.posted ? 'Yes' : 'No'
                ].map(v => `"${v}"`).join(',');
            });
            
            const csv = [headers.join(','), ...rows].join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `samples_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        async function clearCompleted() {
            if (confirm('Delete all completed samples?')) {
                samples = samples.filter(s => !s.done);
                await saveSamples();
                render();
                renderCalendar();
            }
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (ev) => {
                    try {
                        const imported = JSON.parse(ev.target.result);
                        if (confirm(`Import ${imported.length} samples? This will replace your current data.`)) {
                            samples = imported;
                            await saveSamples();
                            render();
                            renderCalendar();
                            alert('Data imported successfully!');
                        }
                    } catch (e) {
                        alert('Invalid file format');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }
        
        // ==================== SUBSCRIPTION MANAGEMENT ====================
        function manageSubscription() {
            const customerPortalUrl = 'https://lazybstudios.lemonsqueezy.com/billing';
            
            if (currentUser && currentUser.email) {
                window.open(`${customerPortalUrl}?email=${encodeURIComponent(currentUser.email)}`, '_blank');
            } else {
                window.open(customerPortalUrl, '_blank');
            }
        }

        // ==================== SCRIPT GENERATOR ====================
        async function generateScript(sampleId) {
            const sample = samples.find(s => s.id === sampleId);
            if (!sample) return;
            
            const loadingModal = document.createElement('div');
            loadingModal.className = 'modal active';
            loadingModal.innerHTML = `
                <div class="modal-content" style="text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 20px;">‚ú®</div>
                    <h2 style="margin-bottom: 10px;">Generating Your Script...</h2>
                    <p style="color: var(--text-secondary);">AI is crafting the perfect TikTok script for ${sample.brand} ${sample.product}</p>
                    <div style="margin-top: 20px;">
                        <div style="width: 100%; height: 4px; background: var(--border); border-radius: 2px; overflow: hidden;">
                            <div style="width: 100%; height: 100%; background: var(--primary); animation: loading 1.5s ease-in-out infinite;"></div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(loadingModal);
            
            try {
                const response = await fetch('https://eiigbmrjtwndanywrcqp.supabase.co/functions/v1/generate-script', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_ANON_KEY
                    },
                    body: JSON.stringify({
                        product: sample.product,
                        brand: sample.brand,
                        notes: sample.notes || '',
                        userId: currentUser.id,
                        sampleId: sample.id
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    loadingModal.remove();
                    
                    if (response.status === 429) {
                        const dailyLimit = userTier === 'pro' ? 5 : 1;
                        showUpgradeModal(
                            `Daily Script Limit Reached!`,
                            `You've used all ${dailyLimit} script${dailyLimit > 1 ? 's' : ''} for today. ${userTier === 'basic' ? 'Upgrade to Pro for 5 scripts per day!' : 'Come back tomorrow for more!'}`,
                            'pro'
                        );
                    } else if (response.status === 403) {
                        showUpgradeModal(
                            'Script Generator is a Premium Feature!',
                            'Get AI-powered TikTok scripts for your products',
                            'basic'
                        );
                    } else {
                        alert('Failed to generate script: ' + (data.error || 'Unknown error'));
                    }
                    return;
                }
                
                loadingModal.remove();
                showScriptModal(sample, data.script);
                
            } catch (error) {
                loadingModal.remove();
                alert('Failed to generate script. Please try again.');
                console.error('Script generation error:', error);
            }
        }

        function showScriptModal(sample, script) {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title">‚ú® Your TikTok Script</h2>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">√ó</button>
                    </div>
                    <div style="margin-bottom: 15px; padding: 10px; background: var(--bg); border-radius: 8px;">
                        <strong>${sample.brand} - ${sample.product}</strong>
                    </div>
                    <div style="white-space: pre-wrap; line-height: 1.6; padding: 15px; background: var(--surface); border-radius: 8px; margin-bottom: 15px; max-height: 400px; overflow-y: auto; border: 1px solid var(--border);">
${script}
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="row-btn" style="background: var(--primary); color: white; flex: 1;" onclick="copyScript(\`${script.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`)">üìã Copy Script</button>
                        <button class="row-btn btn-secondary" style="flex: 1;" onclick="this.closest('.modal').remove(); setTimeout(() => generateScript('${sample.id}'), 100);">üîÑ Generate New</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function copyScript(script) {
            navigator.clipboard.writeText(script).then(() => {
                alert('Script copied to clipboard! üìã');
            }).catch(() => {
                const textarea = document.createElement('textarea');
                textarea.value = script;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert('Script copied to clipboard! üìã');
            });
        }
        
        function togglePasswordVisibility(inputId, button) {
            const input = document.getElementById(inputId);
            if (input.type === 'password') {
                input.type = 'text';
                button.textContent = 'üôà';
            } else {
                input.type = 'password';
                button.textContent = 'üëÅÔ∏è';
            }
        }   
    </script>
    <script>
        // Handle cache-buster
        if (window.location.search.includes('v=update')) {
            window.history.replaceState({}, document.title, window.location.pathname);
        }
    </script>
  

</script>

    <!-- Beta Feedback Modal -->
<div id="betaFeedbackModal" class="modal">
    <div class="modal-content" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
        <div class="modal-header">
            <h2 class="modal-title">üß™ Beta Feedback</h2>
            <button class="modal-close" onclick="closeBetaFeedback()">√ó</button>
        </div>
        
        <div style="background: linear-gradient(135deg, #FE2C55, #FF6B8A); color: white; padding: 15px; border-radius: 12px; margin-bottom: 20px;">
            <p style="font-weight: 600; margin-bottom: 5px;">Thank you for beta testing SampleFlow!</p>
            <p style="font-size: 0.85rem; opacity: 0.9;">Your feedback helps us improve. Progress is saved automatically.
        Click the check mark if the feature works properly or click the x if it doesn't, click N/A if you don't have access to the feature or if it is not visible so you are not able to test the feautre. </p>
        </div>
        
        <div id="betaFeedbackContent">
            <!-- Content loaded dynamically -->
        </div>
    </div>
</div>
    
</body>
</html>
